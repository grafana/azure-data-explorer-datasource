/*! For license information please see module.js.LICENSE.txt */
define(["react","@grafana/ui","emotion","lodash","@grafana/runtime","@grafana/data","app/core/config","angular"],(function(e,t,n,r,a,o,i,l){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/",n(n.s=12)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){e.exports=n},function(e,t){e.exports=r},function(e,t){e.exports=a},function(e,t){e.exports=o},function(e,t){e.exports=i},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var r=function(){return(r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};Object.create;Object.create},function(e,t,n){"use strict";function r(e){return"function"==typeof e?e():e}function a(){var e={};return e.promise=new Promise((function(t,n){e.resolve=t,e.reject=n})),e}e.exports=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=void 0,i=void 0,l=void 0,u=[];return function(){var c=r(t),p=(new Date).getTime(),d=!o||p-o>c;o=p;for(var m=arguments.length,f=Array(m),v=0;v<m;v++)f[v]=arguments[v];if(d&&n.leading)return n.accumulate?Promise.resolve(e.call(this,[f])).then((function(e){return e[0]})):Promise.resolve(e.call.apply(e,[this].concat(f)));if(i?clearTimeout(l):i=a(),u.push(f),l=setTimeout(s.bind(this),c),n.accumulate){var h=u.length-1;return i.promise.then((function(e){return e[h]}))}return i.promise};function s(){var t=i;clearTimeout(l),Promise.resolve(n.accumulate?e.call(this,u):e.apply(this,u[u.length-1])).then(t.resolve,t.reject),u=[],i=null}}},function(e,t){e.exports=l},,function(e){e.exports=JSON.parse('{"name":"grafana-azure-data-explorer-datasource","version":"3.4.0","description":"Grafana data source for Azure Data Explorer","scripts":{"build":"grafana-toolkit plugin:build","test":"grafana-toolkit plugin:test","dev":"grafana-toolkit plugin:dev","watch":"grafana-toolkit plugin:dev --watch"},"author":"Grafana Labs","license":"Apache","devDependencies":{"@grafana/data":"7.1.1","@grafana/e2e":"7.1.1","@grafana/eslint-config":"2.0.0","@grafana/runtime":"7.4.0","@grafana/toolkit":"7.3.1","@grafana/ui":"7.5.0-beta.1","@testing-library/react":"^11.2.5","@types/angular":"1.6.49","@types/debounce-promise":"^3.1.2","@types/grafana":"github:CorpGlory/types-grafana.git","@types/lodash":"^4.14.158","@typescript-eslint/eslint-plugin":"3.6.0","@typescript-eslint/parser":"3.6.0","eslint":"7.4.0","eslint-config-prettier":"6.11.0","eslint-plugin-jsdoc":"28.6.1","eslint-plugin-prettier":"3.1.4","eslint-plugin-react-hooks":"4.0.5","jest-environment-jsdom-sixteen":"^1.0.3","monaco-editor":"0.17.0","ts-jest":"^26.4.3"},"dependencies":{"debounce-promise":"^3.1.2","react-select-event":"^5.2.0","react-use":"^15.3.3"}}')},function(e,t,n){"use strict";n.r(t);var r=n(5),a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function o(e,t){function n(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var i=function(){return(i=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};function l(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(r=Object.getOwnPropertySymbols(e);a<r.length;a++)t.indexOf(r[a])<0&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(n[r[a]]=e[r[a]])}return n}function u(e,t,n,r){return new(n||(n=Promise))((function(a,o){function i(e){try{u(r.next(e))}catch(e){o(e)}}function l(e){try{u(r.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(i,l)}u((r=r.apply(e,t||[])).next())}))}function s(e,t){var n,r,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:l(0),throw:l(1),return:l(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function l(o){return function(l){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(a=2&o[0]?r.return:o[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,o[1])).done)return a;switch(r=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!(a=i.trys,(a=a.length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,l])}}}function c(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function p(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,a,o=n.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)i.push(r.value)}catch(e){a={error:e}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(a)throw a.error}}return i}function d(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(p(arguments[t]));return e}function m(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var f,v=n(3),h=n.n(v),g=n(4),y=function(){function e(){}return e.prototype.parseDatabases=function(e){var t,n,r,a,o=[];if(!e||!e.data||!e.data.Tables||0===e.data.Tables.length)return o;try{for(var i=c(e.data.Tables),l=i.next();!l.done;l=i.next()){var u=l.value;try{for(var s=(r=void 0,c(u.Rows)),p=s.next();!p.done;p=s.next()){var d=p.value;o.push({text:d[5]||d[0],value:d[0]})}}catch(e){r={error:e}}finally{try{p&&!p.done&&(a=s.return)&&a.call(s)}finally{if(r)throw r.error}}}}catch(e){t={error:e}}finally{try{l&&!l.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}return o},e.prototype.parseSchemaResult=function(e){var t=e.Tables[0].Rows[0][0];return JSON.parse(t)},e}();!function(e){e.Property="property",e.Operator="operator",e.Reduce="reduce",e.FunctionParameter="functionParameter",e.GroupBy="groupBy",e.Or="or",e.And="and"}(f||(f={}));var b,w=n(11);!function(e){e.Visual="visual",e.Raw="raw"}(b||(b={}));var C,x={query:"",querySource:b.Raw,expression:{where:{type:f.And,expressions:[]},groupBy:{type:f.And,expressions:[]},reduce:{type:f.And,expressions:[]}},pluginVersion:w.version};!function(e){e.function="function",e.table="table",e.materializedView="materializedView"}(C||(C={}));var E={userId:"userId",login:"login",email:"email",avatarUrl:"avatarUrl",time:"time",timeEnd:"timeEnd",title:"title",text:"text",tags:"tags"};function O(e,t){if(!e)return"";return(e=(e=e.replace(/\$__([_a-zA-Z0-9]+)\(([^\)]*)\)/gi,(function(e,t,n){return"contains"===t?function(e){var t=e.indexOf(","),n=e.substring(0,t),r=e.substring(e.indexOf(",")+1);if(r&&"all"===r.toLowerCase().trim())return"1 == 1";return n.trim()+" in ("+S(r.trim())+")"}(n):e}))).replace(/\$(__interval|__interval_ms)/gi,(function(e,n){var r;if(!t)return e;var a=t[n];return null!==(r=null==a?void 0:a.value)&&void 0!==r?r:e}))).replace(/\$__escapeMulti\(('[^]*')\)/gi,(function(e,t){return(n=t).substring(1,n.length-1).split("','").map((function(e){return"@'"+e+"'"})).join(", ");var n}))}function S(e){return e.match(/,+/i)?e.split(",").map(S).join(","):e.match(/^'(.*)'$/i)?e:"'"+e+"'"}var T,j={},F=function(e,t,n){return void 0===n&&(n=!1),u(void 0,void 0,Promise,(function(){var r;return s(this,(function(a){switch(a.label){case 0:return j[e]&&!n?[3,2]:[4,t()];case 1:r=a.sent(),j[e]=r,a.label=2;case 2:return[2,j[e]]}}))}))};!function(e){e.Number="number",e.String="string",e.Boolean="boolean",e.DateTime="dateTime",e.TimeSpan="timeSpan",e.Function="function",e.Interval="interval"}(T||(T={}));var D=function(e){return(null==e?void 0:e.type)===f.Reduce},k=function(e){return(null==e?void 0:e.type)===f.Property},V=function(e){return(null==e?void 0:e.type)===f.Operator},N=function(e){return(null==e?void 0:e.type)===f.GroupBy},A=function(e){return Array.isArray(null==e?void 0:e.value)},_=function(e){return(null==e?void 0:e.type)===f.And},M=function(e){return(null==e?void 0:e.type)===f.Or},P=function(e){return _(e)||M(e)},I=function(){function e(e){void 0===e&&(e=Object(g.getTemplateSrv)()),this.templateSrv=e}return e.prototype.toAutoCompleteQuery=function(e,t){if(!(null==e?void 0:e.expression)||!e.expression.from||!e.search.property)return"";var n={timeColumn:R(t,null==e?void 0:e.expression),castIfDynamic:function(e){return L(e,t)}},r=[];this.appendProperty(n,e.expression.from,r),this.appendTimeFilter(n,void 0,r);var a=z(e.index,e.expression.where,e.search),o=e.search.property.name;return this.appendWhere(n,a,r,"where"),r.push("take 50000"),r.push("distinct "+n.castIfDynamic(o)),r.push("take 251"),r.join("\n| ")},e.prototype.toQuery=function(e,t){if(!e||!e.from)return"";var n={timeColumn:R(t,e),castIfDynamic:function(e){return L(e,t)}},r=[];return this.appendProperty(n,e.from,r),this.appendTimeFilter(n,e.timeshift,r),this.appendWhere(n,null==e?void 0:e.where,r,"where"),this.appendTimeshift(n,e.timeshift,r),this.appendSummarize(n,e.reduce,e.groupBy,r),this.appendOrderBy(n,e.groupBy,e.reduce,r),0===r.length?"":r.join("\n| ")},e.prototype.appendTimeshift=function(e,t,n){var r=W(e,t);r&&n.push("extend "+e.timeColumn+" = "+e.timeColumn+" + "+r)},e.prototype.appendTimeFilter=function(e,t,n){if(e.timeColumn){var r=W(e,t);r?n.push("where "+e.timeColumn+" between (($__timeFrom - "+r+") .. ($__timeTo - "+r+"))"):B(e.timeColumn)?n.push("where "+e.timeColumn+" between ($__timeFrom .. $__timeTo)"):n.push("where $__timeFilter("+e.timeColumn+")")}},e.prototype.appendOrderBy=function(e,t,n,r){if(e.timeColumn){var a=Array.isArray(t.expressions)&&0===t.expressions.length,o=Array.isArray(n.expressions)&&0===n.expressions.length;if(a&&o)r.push("order by "+e.timeColumn+" asc");else t.expressions.find((function(e){return!(!N(e)||!e.interval)}))&&r.push("order by "+e.timeColumn+" asc")}},e.prototype.appendWhere=function(e,t,n,r){var a=this;if(t){if(_(t))return t.expressions.forEach((function(t){return a.appendWhere(e,t,n,r)}));if(M(t)){var o=[];if(t.expressions.map((function(t){return a.appendWhere(e,t,o)})),0===o.length)return;return n.push("where "+o.join(" or "))}return V(t)?this.appendOperator(e,t,n,r):void 0}},e.prototype.appendSummarize=function(e,t,n,r){var a,o,i,l,u,s,p=this,d=!1,m=[],f=[],v=[];try{for(var h=c(null!==(u=null==t?void 0:t.expressions)&&void 0!==u?u:[]),g=h.next();!g.done;g=h.next()){var y=g.value;if(D(y)){var b=y.reduce.name,w=y.parameters,C=e.castIfDynamic(y.property.name);if(v.push(C),Array.isArray(w)){var x=w.map((function(e){return p.formatValue(e.value,e.fieldType)})).join(", ");m.push(b+"("+C+", "+x+")")}else"count"!==b?"none"===b||m.push(b+"("+C+")"):d||(d=!0,m.push("count()"))}}}catch(e){a={error:e}}finally{try{g&&!g.done&&(o=h.return)&&o.call(h)}finally{if(a)throw a.error}}try{for(var E=c(null!==(s=null==n?void 0:n.expressions)&&void 0!==s?s:[]),O=E.next();!O.done;O=E.next()){y=O.value;if(N(y)){C=e.castIfDynamic(y.property.name);if(y.interval){var S=y.interval.name;f.unshift("bin("+C+", "+S+")")}else f.push(C)}}}catch(e){i={error:e}}finally{try{O&&!O.done&&(l=E.return)&&l.call(E)}finally{if(i)throw i.error}}if(m.length>0)return f.length>0?void r.push("summarize "+m.join(", ")+" by "+f.join(", ")):void r.push("summarize "+m.join(", "));f.length>0?r.push("summarize by "+f.join(", ")):v.length>0&&r.push("project "+v.join(", "))},e.prototype.appendOperator=function(e,t,n,r){var a=t.property,o=t.operator;if(a.name&&o.name)switch(o.name){case"isnotempty":n.push(q(o.name+"("+a.name+")",r));break;default:var i=this.formatValue(o.value,a.type);n.push(q(a.name+" "+o.name+" "+i,r))}},e.prototype.formatValue=function(e,t){var n=this;if(Array.isArray(e))return"("+e.map((function(e){return n.formatValue(e,t)})).join(", ")+")";if(this.isTemplateVariable(e))return e;switch(t){case T.Number:case T.Boolean:return e;default:return"'"+e+"'"}},e.prototype.appendProperty=function(e,t,n){n.push(this.formatProperty(t.property.name))},e.prototype.formatProperty=function(e){return/[\s\.-]/.test(e)&&!/[\$\(]/.test(e)?"['"+e+"']":e},e.prototype.isTemplateVariable=function(e){return!!Array.isArray(this.templateSrv.getVariables())&&!!this.templateSrv.getVariables().find((function(t){return"$"+(null==t?void 0:t.id)===e}))},e}(),q=function(e,t){return t?t+" "+e:e},R=function(e,t){if(Array.isArray(null==t?void 0:t.groupBy.expressions)){var n=null==t?void 0:t.groupBy.expressions.find((function(e){return!!N(e)&&(e.property.type===T.DateTime&&e.interval)}));if(N(n))return L(n.property.name,e)}if(Array.isArray(e)){var r=null==e?void 0:e.find((function(e){return"datetime"===e.CslType&&-1===e.Name.indexOf(".")}));if(r)return null==r?void 0:r.Name;var a=null==e?void 0:e.find((function(e){return"datetime"===e.CslType}));return a?$(a):a}},B=function(e){return!!(e&&e.indexOf(".")>-1)||!!(e&&e.indexOf("todynamic")>-1)},L=function(e,t){if(!B(e)||!Array.isArray(t))return e;var n=t.find((function(t){return t.Name===e}));return n?$(n):e},$=function(e){var t=e.Name.split(".");return t.reduce((function(n,r,a){return n?a+1===t.length?"to"+e.CslType+"("+n+"."+r+")":"todynamic("+n+"."+r+")":"todynamic("+r+")"}),"")},z=function(e,t,n){for(var r=e.split("-").map((function(e){return parseInt(e,10)})),a=Object(v.cloneDeep)(t),o=a.expressions,i=0;i<r.length;i++){var l=r[i];if(i===r.length-1){o[l]=n;break}if(Array.isArray(o)){var u=o[l];if(P(u)){o=u.expressions;continue}}}return a},W=function(e,t){if(!t||!e.timeColumn||!t.property)return null;var n=t.property.name;return/^(\d{1,15}(?:d|h|ms|s|m){0,1})$/gm.test(n)?n:null},Q=function(e){return{value:e.Name,label:e.Name,type:T.String}},G=function(e){switch(e){case"real":case"int":case"long":return T.Number;case"datetime":return T.DateTime;case"bool":return T.Boolean;default:return T.String}},U=function(e){return Object.values(e).every((function(e){return void 0!==e}))&&!!e.database&&!!e.displayName&&!!e.name&&!!e.type&&!!e.value},K=function(){function e(e,t){var n,r;void 0===e&&(e=!1),void 0===t&&(t=[]),this.enabled=e,this.mappingsByDatabase={},this.displayNameToMapping={},this.nameToMapping={},this.valueToMapping={};try{for(var a=c(t),o=a.next();!o.done;o=a.next()){var i=o.value;U(i)&&(Array.isArray(this.mappingsByDatabase[i.database])||(this.mappingsByDatabase[i.database]=[]),this.mappingsByDatabase[i.database].push(i),this.displayNameToMapping[i.displayName]=i,this.nameToMapping[i.name]=i,this.valueToMapping[i.value]=i)}}catch(e){n={error:e}}finally{try{o&&!o.done&&(r=a.return)&&r.call(a)}finally{if(n)throw n.error}}}return e.prototype.getMappingByValue=function(e){if(this.enabled&&e)return this.valueToMapping[e]},e.prototype.getTableOptions=function(e,t){var n=e.Databases[t];if(!n||!n.Tables)return[];if(!this.enabled)return Object.keys(n.Tables).map((function(e){return function(e){return{label:e.Name,value:e.Name,type:T.String}}(n.Tables[e])}));var r=this.mappingsByDatabase[t];return H(n,r)},e}(),H=function(e,t){return void 0===t&&(t=[]),t.reduce((function(t,n){return n.type===C.table&&e.Tables[n.name]?(console.log("if (database.Tables[mapping.name])",n),t.push(J(n)),t):n.type===C.materializedView&&e.MaterializedViews[n.name]?(console.log("if (database.MaterializedViews[mapping.name])",n),t.push(J(n)),t):n.type===C.function&&e.Functions[n.name]?(console.log("if (database.Functions[mapping.name])",n),t.push(J(n)),t):t}),[])},J=function(e){return{type:T.String,label:e.displayName,value:e.value}};function Z(e){return(Z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var X=function(e){function t(t){var n,r,a,o=e.call(this,t)||this,i=null!==(n=t.jsonData.useSchemaMapping)&&void 0!==n&&n,l=null!==(r=t.jsonData.schemaMappings)&&void 0!==r?r:[];return o.backendSrv=Object(g.getBackendSrv)(),o.templateSrv=Object(g.getTemplateSrv)(),o.baseUrl="/azuredataexplorer",o.defaultOrFirstDatabase=t.jsonData.defaultDatabase,o.url=t.url,o.defaultEditorMode=null!==(a=t.jsonData.defaultEditorMode)&&void 0!==a?a:b.Visual,o.schemaMapper=new K(i,l),o.expressionParser=new I(o.templateSrv),o.parseExpression=o.parseExpression.bind(o),o.autoCompleteQuery=o.autoCompleteQuery.bind(o),o.getSchemaMapper=o.getSchemaMapper.bind(o),o}return o(t,e),t.prototype.filterQuery=function(e){var t,n;if(e.hide||!e.query)return!1;if(void 0===e.rawMode&&e.query)return!0;if(e.rawMode)return!0;var r=null===(t=e.expression)||void 0===t?void 0:t.from;return!!r&&!!(null===(n=r.property)||void 0===n?void 0:n.name)},t.prototype.applyTemplateVariables=function(e,t){var n=O(this.templateSrv.replace(e.query,t,this.interpolateVariable),t);return i(i({},e),{query:n,database:this.templateSrv.replace(e.database,t)})},t.prototype.annotationQuery=function(t){return u(this,void 0,Promise,(function(){var n;return s(this,(function(a){return(n=t.annotation)?(n.resultFormat="table",[2,e.prototype.query.call(this,{targets:[n],range:t.range,maxDataPoints:200,interval:"10ms",intervalMs:1e4}).toPromise().then((function(e){var n;return e.state===r.LoadingState.Done&&(null===(n=e.data)||void 0===n?void 0:n.length)?function(e,t){var n,a,o,l,u,s,d,m=[];if(!e||!e.length)return m;var f=!1,v=!1,h={};try{for(var g=c(e.fields),y=g.next();!y.done;y=g.next()){h[(_=y.value).name.toLowerCase()]=_}}catch(e){n={error:e}}finally{try{y&&!y.done&&(a=g.return)&&a.call(g)}finally{if(n)throw n.error}}var b=[],w=i(i({},E),null==t?void 0:t.field);try{for(var C=c(Object.entries(w)),x=C.next();!x.done;x=C.next()){var O=p(x.value,2),S=O[0],T=O[1],j=T?T.toLowerCase():"";if(j&&h[j]){var F={key:S,field:h[j]};switch(S){case"time":f=!0;break;case"text":v=!0;break;case"tags":F.split=","}(null==t?void 0:t.regex)&&t.regex[S]&&(F.regex=new RegExp(t.regex[S])),b.push(F)}}}catch(e){o={error:e}}finally{try{x&&!x.done&&(l=C.return)&&l.call(C)}finally{if(o)throw o.error}}if(!f){if(!(D=e.fields.find((function(e){return e.type===r.FieldType.time}))))return[];b.push({key:"time",field:D})}if(!v){var D;if(!(D=e.fields.find((function(e){return e.type===r.FieldType.string}))))return[];(null===(d=null==t?void 0:t.regex)||void 0===d?void 0:d.text)?b.push({key:"time",field:D,regex:new RegExp(t.regex.text)}):b.push({key:"time",field:D})}for(var k=0;k<e.length;k++){var V={};try{for(var N=(u=void 0,c(b)),A=N.next();!A.done;A=N.next()){var _;F=(_=A.value).field.values.get(k);if(_.regex){var M=_.regex.exec(F);M&&(F=M[1]?M[1]:M[0])}_.split&&(F=F.split(",")),V[_.key]=F}}catch(e){u={error:e}}finally{try{A&&!A.done&&(s=N.return)&&s.call(N)}finally{if(u)throw u.error}}m.push(V)}return m}(e.data[0],{field:{time:"StartTime"}}):e.state===r.LoadingState.Error?(console.log("ADX Annotation ERROR???",t,e),Promise.reject({message:t.annotation.name})):[]}))]):[2,Promise.reject({message:"Query missing in annotation definition"})]}))}))},t.prototype.metricFindQuery=function(e,t){return u(this,void 0,Promise,(function(){var n=this;return s(this,(function(a){return e.match(/^databases\(\)/i)?[2,this.getDatabases()]:[2,this.getDefaultOrFirstDatabase().then((function(r){return n.buildQuery(e,t,r)})).then((function(e){return n.query({targets:[e]}).toPromise()})).then((function(e){return e.data&&e.data.length?function(e){var t=[],n=e.fields.find((function(e){return e.type===r.FieldType.string}));if(n)for(var a=0;a<n.values.length;a++)t.push({text:n.values.get(a)});return t}(e.data[0]):[]})).catch((function(e){throw console.log("There was an error",e),e}))]}))}))},t.prototype.getDatabases=function(){return u(this,void 0,Promise,(function(){var e,t;return s(this,(function(n){return e=this.baseUrl+"/v1/rest/mgmt",t={csl:".show databases"},[2,this.doRequest(e,t).then((function(e){return(new y).parseDatabases(e)}))]}))}))},t.prototype.getDefaultOrFirstDatabase=function(){return u(this,void 0,Promise,(function(){var e=this;return s(this,(function(t){return this.defaultOrFirstDatabase?[2,Promise.resolve(this.defaultOrFirstDatabase)]:[2,this.getDatabases().then((function(t){return e.defaultOrFirstDatabase=t[0].value,e.defaultOrFirstDatabase}))]}))}))},t.prototype.getSchema=function(e){return void 0===e&&(e=!1),u(this,void 0,Promise,(function(){var t=this;return s(this,(function(n){return[2,F(this.id+".schema.overview",(function(){var e=t.baseUrl+"/v1/rest/mgmt";return t.doRequest(e,{querySource:"schema",csl:".show databases schema as json"}).then((function(e){return(new y).parseSchemaResult(e.data)}))}),e)]}))}))},t.prototype.getFunctionSchema=function(e,t){return u(this,void 0,Promise,(function(){var n,r,a;return s(this,(function(o){switch(o.label){case 0:return"take 50000",(n=[]).push(t),n.push("take 50000"),n.push("getschema"),r=this.buildQuery(n.join("\n | "),{},e),[4,this.query({targets:[i(i({},r),{querySource:"schema"})]}).toPromise()];case 1:return a=o.sent(),[2,Y(a.data)]}}))}))},t.prototype.getDynamicSchema=function(e,t,n){return u(this,void 0,Promise,(function(){var r,a,o,l,u,c;return s(this,(function(s){switch(s.label){case 0:return e&&t&&Array.isArray(n)&&0!==n.length?(r=[],"take 50000",a="where "+n.map((function(e){return"isnotnull("+e+")"})).join(" and "),o="project "+n.map((function(e){return e})).join(", "),l="summarize "+n.map((function(e){return"buildschema("+e+")"})).join(", "),r.push(t),r.push("take 50000"),r.push(a),r.push(o),r.push(l),u=this.buildQuery(r.join("\n | "),{},e),[4,this.query({targets:[i(i({},u),{querySource:"schema"})]}).toPromise()]):[2,{}];case 1:return c=s.sent(),[2,ee(c.data)]}}))}))},t.prototype.getVariables=function(){return this.templateSrv.getVariables().map((function(e){return"$"+e.name}))},t.prototype.buildQuery=function(e,t,n){t||(t={}),t.hasOwnProperty("scopedVars")||(t.scopedVars={});var r=O(this.templateSrv.replace(e,t.scopedVars,this.interpolateVariable),t.scopedVars);return i(i({},x),{refId:"adx-"+r,resultFormat:"table",rawMode:!0,query:r,database:n})},t.prototype.doRequest=function(e,t,n){var r=this;return void 0===n&&(n=1),this.backendSrv.datasourceRequest({url:this.url+e,method:"POST",data:t}).catch((function(a){if(n>0)return r.doRequest(e,t,n-1);throw a}))},t.prototype.interpolateVariable=function(e,t){return"string"==typeof e?t.multi||t.includeAll?"'"+e+"'":e:"number"==typeof e?e:Object(v.map)(e,(function(t){return"number"==typeof e?e:"'"+re(t)+"'"})).filter((function(e){return"''"!==e})).join(",")},t.prototype.getSchemaMapper=function(){return this.schemaMapper},t.prototype.parseExpression=function(e,t){return this.expressionParser.toQuery(e,t)},t.prototype.getDefaultEditorMode=function(){return this.defaultEditorMode},t.prototype.autoCompleteQuery=function(e,t){return u(this,void 0,Promise,(function(){var n,r,a,o,l;return s(this,(function(u){switch(u.label){case 0:return(n=this.expressionParser.toAutoCompleteQuery(e,t))?(r=i(i({},x),{refId:"adx-"+n,database:e.database,rawMode:!0,query:n,resultFormat:"table",querySource:"autocomplete"}),[4,this.query(ne({targets:[r]})).toPromise()]):[2,[]];case 1:return a=u.sent(),Array.isArray(null==a?void 0:a.data)&&0!==a.data.length?Array.isArray(a.data[0].fields)&&0!==a.data[0].fields.length?(o=a.data[0].fields[0].values.toArray(),[2,"contains"===(l=e.search.operator).name?ae(o,l.value):o]):[2,[]]:[2,[]]}}))}))},t}(g.DataSourceWithBackend),Y=function(e){var t,n,r=[],a=e[0].fields;if(!a)return r;var o=a.findIndex((function(e){return"ColumnName"===e.name})),i=a.findIndex((function(e){return"ColumnType"===e.name}));if(o<0||i<0)return r;try{for(var l=c(e),u=l.next();!u.done;u=l.next())for(var s=u.value,p=0;p<s.length;p++)r.push({Name:s.fields[o].values.get(p),CslType:s.fields[i].values.get(p)})}catch(e){t={error:e}}finally{try{u&&!u.done&&(n=l.return)&&n.call(l)}finally{if(t)throw t.error}}return r},ee=function(e){var t,n,r,a,o={};try{for(var i=c(e),l=i.next();!l.done;l=i.next()){var u=l.value;try{for(var s=(r=void 0,c(u.fields)),p=s.next();!p.done;p=s.next()){var d=p.value,m=JSON.parse(d.values.get(0));if(null!==m){var f=[],v=d.name.replace("schema_","");te(v,m,f),o[v]=f}else console.log("error with field",d)}}catch(e){r={error:e}}finally{try{p&&!p.done&&(a=s.return)&&a.call(s)}finally{if(r)throw r.error}}}}catch(e){t={error:e}}finally{try{l&&!l.done&&(n=i.return)&&n.call(i)}finally{if(t)throw t.error}}return o},te=function e(t,n,r){var a,o;if(n)try{for(var i=c(Object.keys(n)),l=i.next();!l.done;l=i.next()){var u=l.value,s=t+"."+u;"string"!=typeof n[u]?"object"===Z(n[u])&&e(s,n[u],r):r.push({Name:s,CslType:n[u]})}}catch(e){a={error:e}}finally{try{l&&!l.done&&(o=i.return)&&o.call(i)}finally{if(a)throw a.error}}else console.log("error with column",t)},ne=function(e){var t,n=null===(t=Object(g.getTemplateSrv)())||void 0===t?void 0:t.timeRange;return n?i(i({},e),{range:n}):e},re=function(e){return e.replace(/\'/gim,"\\'")},ae=function(e,t){var n=t.toLowerCase();return e.sort((function(e,t){if(!e&&!t)return 0;if(!e&&t)return-1;if(e&&!t)return 1;var r=e.toLowerCase(),a=t.toLowerCase();return r.startsWith(n)&&a.startsWith(n)?0:r.startsWith(n)&&!a.startsWith(n)&&a.includes(n,1)||r.startsWith(n)&&!a.includes(n,1)?-1:!r.startsWith(n)&&r.includes(n,1)&&a.startsWith(n)||!r.includes(n,1)&&a.startsWith(n)?1:r.includes(n,1)&&!a.includes(n,1)?-1:!r.includes(n,1)&&a.includes(n,1)?1:0})),e},oe=n(0),ie=n.n(oe),le=n(7);function ue(e,t,n){void 0===t&&(t=[]),void 0===n&&(n={loading:!1});var r,a,o=Object(oe.useRef)(0),i=(r=Object(oe.useRef)(!1),a=Object(oe.useCallback)((function(){return r.current}),[]),Object(oe.useEffect)((function(){return r.current=!0,function(){r.current=!1}})),a),l=Object(oe.useState)(n),u=l[0],s=l[1];return[u,Object(oe.useCallback)((function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];var r=++o.current;return s((function(e){return Object(le.a)(Object(le.a)({},e),{loading:!0})})),e.apply(void 0,t).then((function(e){return i()&&r===o.current&&s({value:e,loading:!1}),e}),(function(e){return i()&&r===o.current&&s({error:e,loading:!1}),e}))}),t)]}function se(e,t){void 0===t&&(t=[]);var n=ue(e,t,{loading:!0}),r=n[0],a=n[1];return Object(oe.useEffect)((function(){a()}),[a]),r}var ce,pe,de,me,fe,ve,he,ge,ye,be,we,Ce,xe,Ee,Oe,Se,Te,je,Fe,De,ke,Ve,Ne,Ae,_e,Me=n(1),Pe=n(2),Ie=function(){function e(e,t,n,r){this.containerDiv=e,this.defaultTimeField=t,this.getSchema=n,this.config=r,this.splitWithNewLineRegex=/[^\n]+\n?|\n/g,this.newLineRegex=/\r?\n/,this.startsWithKustoPipeRegex=/^\|\s*/g,this.kustoPipeRegexStrict=/^\|\s*$/g}return e.prototype.initMonaco=function(e){var t=this,n=this.config.bootData.user.lightTheme?"grafana-light":"vs-dark";monaco.editor.defineTheme("grafana-light",{base:"vs",inherit:!0,rules:[{token:"comment",foreground:"008000"},{token:"variable.predefined",foreground:"800080"},{token:"function",foreground:"0000FF"},{token:"operator.sql",foreground:"FF4500"},{token:"string",foreground:"B22222"},{token:"operator.scss",foreground:"0000FF"},{token:"variable",foreground:"C71585"},{token:"variable.parameter",foreground:"9932CC"},{token:"",foreground:"000000"},{token:"type",foreground:"0000FF"},{token:"tag",foreground:"0000FF"},{token:"annotation",foreground:"2B91AF"},{token:"keyword",foreground:"0000FF"},{token:"number",foreground:"191970"},{token:"annotation",foreground:"9400D3"},{token:"invalid",background:"cd3131"}],colors:{"textCodeBlock.background":"#FFFFFF"}}),monaco.languages.kusto.kustoDefaults.setLanguageSettings({includeControlCommands:!0,newlineAfterPipe:!0,useIntellisenseV2:!1}),this.codeEditor=monaco.editor.create(this.containerDiv,{value:e||"Write your query here",language:"kusto",selectionHighlight:!1,theme:n,folding:!0,lineNumbers:"off",lineHeight:16,suggestFontSize:13,dragAndDrop:!1,occurrencesHighlight:!1,minimap:{enabled:!1},renderIndentGuides:!1,wordWrap:"on"}),this.codeEditor.layout(),1===monaco.editor.getModels().length&&(this.completionItemProvider=monaco.languages.registerCompletionItemProvider("kusto",{triggerCharacters:["."," "],provideCompletionItems:this.getCompletionItems.bind(this)}),this.signatureHelpProvider=monaco.languages.registerSignatureHelpProvider("kusto",{signatureHelpTriggerCharacters:["(",")"],provideSignatureHelp:this.getSignatureHelp.bind(this)})),this.codeEditor.createContextKey("readyToExecute",!0),this.codeEditor.onDidChangeCursorSelection((function(e){t.onDidChangeCursorSelection(e)})),this.getSchema().then((function(e){e&&monaco.languages.kusto.getKustoWorker().then((function(n){var r,a=null===(r=t.codeEditor)||void 0===r?void 0:r.getModel();a&&n(a.uri).then((function(n){var r,a=Object.keys(e.Databases).length>0?Object.keys(e.Databases)[0]:"";n.setSchemaFromShowSchema(e,"https://help.kusto.windows.net",a),null===(r=t.codeEditor)||void 0===r||r.layout()}))}))}))},e.prototype.resize=function(){var e;null===(e=this.codeEditor)||void 0===e||e.layout()},e.prototype.setOnDidChangeModelContent=function(e){var t;null===(t=this.codeEditor)||void 0===t||t.onDidChangeModelContent(e)},e.prototype.disposeMonaco=function(){if(this.completionItemProvider)try{this.completionItemProvider.dispose()}catch(e){console.error("Failed to dispose the completion item provider.",e)}if(this.signatureHelpProvider)try{this.signatureHelpProvider.dispose()}catch(e){console.error("Failed to dispose the signature help provider.",e)}if(this.codeEditor)try{this.codeEditor.dispose()}catch(e){console.error("Failed to dispose the editor component.",e)}},e.prototype.addCommand=function(e,t){var n;null===(n=this.codeEditor)||void 0===n||n.addCommand(e,t,"readyToExecute")},e.prototype.getValue=function(){var e;return null===(e=this.codeEditor)||void 0===e?void 0:e.getValue()},e.prototype.toSuggestionController=function(e){return e},e.prototype.setEditorContent=function(e){var t;null===(t=this.codeEditor)||void 0===t||t.setValue(e)},e.prototype.getCompletionItems=function(e,t){var n="##### Macro that uses the selected timerange in Grafana to filter the query.\n\n- `$__timeFilter()` -> Uses the "+this.defaultTimeField+" column\n\n- `$__timeFilter(datetimeColumn)` ->  Uses the specified datetime column to build the query.",r=e.getValueInRange({startLineNumber:1,startColumn:1,endLineNumber:t.lineNumber,endColumn:t.column});return h.a.includes(r,"|")?h.a.includes(r.toLowerCase(),"where")?h.a.includes(e.getLineContent(t.lineNumber).toLowerCase(),"where")?[{label:"$__timeFilter(timeColumn)",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"\\$__timeFilter(${0:"+this.defaultTimeField+"})"},documentation:{value:n}},{label:"$__from",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"\\$__from"},documentation:{value:"Built-in variable that returns the from value of the selected timerange in Grafana.\n\nExample: `where "+this.defaultTimeField+" > $__from` "}},{label:"$__to",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"\\$__to"},documentation:{value:"Built-in variable that returns the to value of the selected timerange in Grafana.\n\nExample: `where "+this.defaultTimeField+" < $__to` "}},{label:"$__timeInterval",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"\\$__timeInterval"},documentation:{value:"##### Built-in variable that returns an automatic time grain suitable for the current timerange.\n\nUsed with the bin() function - `bin("+this.defaultTimeField+", $__timeInterval)` \n\n[Grafana docs](http://docs.grafana.org/reference/templating/#the-interval-variable)"}}]:[]:[{label:"where $__timeFilter(timeColumn)",kind:monaco.languages.CompletionItemKind.Keyword,insertText:{value:"where \\$__timeFilter(${0:"+this.defaultTimeField+"})"},documentation:{value:n}}]:[]},e.prototype.getSignatureHelp=function(e,t,n){return"$__timeFilter("!==e.getValueInRange({startLineNumber:t.lineNumber,startColumn:t.column-14,endLineNumber:t.lineNumber,endColumn:t.column})?{}:{activeParameter:0,activeSignature:0,signatures:[{label:"$__timeFilter(timeColumn)",parameters:[{label:"timeColumn",documentation:"Default is "+this.defaultTimeField+" column. Datetime column to filter data using the selected date range. "}]}]}},e.prototype.onDidChangeCursorSelection=function(e){"modelChange"===e.source&&e.reason===monaco.editor.CursorChangeReason.RecoverFromMarkers&&(" "===this.getCharAt(e.selection.positionLineNumber,e.selection.positionColumn-1)&&this.triggerSuggestions())},e.prototype.triggerSuggestions=function(){var e,t=null===(e=this.codeEditor)||void 0===e?void 0:e.getContribution("editor.contrib.suggestController");if(t){var n=this.toSuggestionController(t);n._model.cancel(),setTimeout((function(){n._model.trigger(!0)}),10)}},e.prototype.getCharAt=function(e,t){var n,r=null===(n=this.codeEditor)||void 0===n?void 0:n.getModel();if(!r)return"";if(0===r.getLineCount()||r.getLineCount()<e)return"";var a=r.getLineContent(e);return a.length<t||t<1?"":a[t-1]},e}(),qe=n(6),Re=n.n(qe),Be=function(e){function t(t){var n=e.call(this,t)||this;return n.getStyles=Object(Me.stylesFactory)((function(){return{editor:Object(Pe.css)(ce||(ce=m(["\n      width: 100%;\n      height: 350px;\n    "],["\n      width: 100%;\n      height: 350px;\n    "])))}})),n.styles=n.getStyles(),n.monacoRef=ie.a.createRef(),n.state={content:t.content},window.hasOwnProperty("monaco")?setTimeout((function(){n.initMonaco()}),1):window.System.import(t.pluginBaseUrl+"/libs/monaco.min.js").then((function(){setTimeout((function(){n.initMonaco()}),1)})),n}return o(t,e),t.prototype.initMonaco=function(){var e=this;this.kustoCodeEditor=new Ie(this.monacoRef.current,this.props.defaultTimeField,this.props.getSchema,Re.a),this.kustoCodeEditor.initMonaco(this.props.content),this.kustoCodeEditor.addCommand(monaco.KeyMod.Shift|monaco.KeyCode.Enter,(function(){var t,n=null===(t=e.kustoCodeEditor)||void 0===t?void 0:t.getValue();e.props.onChange(n),e.props.onExecute()})),this.kustoCodeEditor.setOnDidChangeModelContent((function(){var t,n=null===(t=e.kustoCodeEditor)||void 0===t?void 0:t.getValue();e.props.onChange(n)})),window.onresize=function(){var t;null===(t=e.kustoCodeEditor)||void 0===t||t.resize()}},t.prototype.componentWillUnmount=function(){this.kustoCodeEditor&&this.kustoCodeEditor.disposeMonaco()},t.prototype.render=function(){return ie.a.createElement("div",{id:"content",tabIndex:0,className:this.styles.editor,ref:this.monacoRef})},t}(ie.a.Component),Le=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"}],$e={label:"ADX Time series",value:"time_series_adx_series"},ze=function(e){var t=e.onChangeFormat,n=Object(oe.useCallback)((function(e){e&&e.value&&t(e.value)}),[t]),r=We();return ie.a.createElement("div",{className:r.container},ie.a.createElement(Me.InlineFormLabel,{className:"query-keyword",width:6},"Format as"),ie.a.createElement(Me.Select,{options:e.includeAdxTimeFormat?d(Le,[$e]):Le,value:e.format,onChange:n}))},We=Object(Me.stylesFactory)((function(){return{container:Object(Pe.css)(pe||(pe=m(["\n      display: flex;\n      flex-direction: row;\n      margin-right: 4px;\n    "],["\n      display: flex;\n      flex-direction: row;\n      margin-right: 4px;\n    "])))}})),Qe=function(e,t){var n=Le.find((function(t){return t.value===e}));return t&&$e.value&&$e.value===e?$e.value:n&&n.value?n.value:Le.length>0&&Le[0].value?Le[0].value:"time_series"},Ge=["//change this to create your own time series query","","<table name>","| where $__timeFilter(Timestamp)","// | summarize count() by <group by column>, bin(Timestamp, $__timeInterval)","// | order by Timestamp asc"].join("\n"),Ue=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state={},t.onRawQueryChange=function(e){var n=Qe(t.props.query.resultFormat,!0);t.props.onChange(i(i({},t.props.query),{query:e,database:t.props.database,resultFormat:n}))},t.onChangeResultFormat=function(e){t.props.onChange(i(i({},t.props.query),{resultFormat:e}))},t}return o(t,e),t.prototype.render=function(){var e=this,t=this.props,n=t.query,r=t.datasource,a=t.lastQueryError,o=t.lastQuery,i=t.timeNotASC,l=t.schema,c=this.state,p=c.showLastQuery,d=c.showHelp,m=Qe(n.resultFormat,!0),f=Re.a.appSubUrl+"/"+r.meta.baseUrl,v=Ke();return l?ie.a.createElement("div",null,ie.a.createElement(Be,{defaultTimeField:"Timestamp",pluginBaseUrl:f,content:n.query||Ge,getSchema:function(){return u(e,void 0,void 0,(function(){return s(this,(function(e){return[2,l]}))}))},onChange:this.onRawQueryChange,onExecute:this.props.onRunQuery}),ie.a.createElement("div",{className:v.toolbar},ie.a.createElement(ze,{includeAdxTimeFormat:!0,format:m,onChangeFormat:this.onChangeResultFormat}),ie.a.createElement("div",{className:"gf-form"},ie.a.createElement("label",{className:"gf-form-label query-keyword",onClick:function(){return e.setState({showHelp:!d})}},"Show Help ",ie.a.createElement(Me.Icon,{name:d?"angle-down":"angle-right"}))),ie.a.createElement("div",{className:"gf-form","ng-show":"ctrl.lastQuery"},ie.a.createElement("label",{className:"gf-form-label query-keyword",onClick:function(){return e.setState({showLastQuery:!p})}},"Raw Query ",ie.a.createElement(Me.Icon,{name:p?"angle-down":"angle-right"}))),ie.a.createElement("div",{className:"gf-form gf-form--grow"},ie.a.createElement("div",{className:"gf-form-label gf-form-label--grow"}))),p&&ie.a.createElement("div",{className:"gf-form"},ie.a.createElement("pre",{className:"gf-form-pre"},o)),a&&ie.a.createElement("div",{className:"gf-form"},ie.a.createElement("pre",{className:"gf-form-pre alert alert-error"},a)),i&&ie.a.createElement("div",{className:"gf-form"},ie.a.createElement("pre",{className:"gf-form-pre alert alert-warning"},"Data is not sorted ascending by Time. Recommend adding an order by clause.")),d&&ie.a.createElement("div",{className:"gf-form"},ie.a.createElement("pre",{className:"gf-form-pre alert alert-info"},'\n  Format as Table:\n  - Can return any set of columns.\n\n  Format as Time series:\n  - Requires exactly one column of Kusto type datetime. (tip: can use Kusto\'s project-away operator to remove columns).\n  - Requires at least one value column of a number type. Each value column is considered a metric.\n  - May optionally have one or more string columns. Each string column is considered as a key=value tag pair (where the key is the column name, and the value is the value of the column for each row).\n  - A time series is returned for each value column + unique set of string column values. Each series has name of valueColumnName { stringColumnName=columnValue, ... }. If there are no string columns in the request, the name will just be valueColumnName.\n  - Example Time Series Query:\n    AzureActivity\n      | where $__timeFilter()\n      | summarize count() by Category, bin(TimeGenerated, 60min)\n      | order by TimeGenerated asc\n\n  Format as ADX Time series:\n   - Used for queries that return Kusto\'s "time series" type, such as the make-series operator\n   - Must have a datetime column named "Timestamp"\n   - Example ADX Time series query:\n    let T = range Timestamp from $__timeFrom to $__timeTo step $__timeInterval * 4\n      | extend   Person = dynamic(["Torkel", "Daniel", "Kyle", "Sofia"]) \n      | extend   Place  = dynamic(["EU",     "EU",     "US",   "EU"]) \n      | mvexpand Person, Place\n      | extend   HatInventory = rand(5) \n      | project  Timestamp, tostring(Person), tostring(Place), HatInventory;\n    T | make-series avg(HatInventory) on Timestamp from $__timeFrom to $__timeTo step $__timeInterval * 4 by Person, Place;\n\n\n  Time Macros:\n  - $__timeFilter -&gt; TimeGenerated &ge; datetime(2018-06-05T18:09:58.907Z) and TimeGenerated &le; datetime(2018-06-05T20:09:58.907Z)\n  - $__timeFilter(datetimeColumn) -&gt;  datetimeColumn  &ge; datetime(2018-06-05T18:09:58.907Z) and datetimeColumn &le; datetime(2018-06-05T20:09:58.907Z)\n  - $__timeFrom -&gt;  datetime(2018-06-05T18:09:58.907Z) [the start time of the query]\n  - $__timeTo -&gt; datetime(2018-06-05T20:09:58.907Z) [the end time of the query]\n  - $__timeInterval -&gt; 5000ms [Grafana\'s recommended bin size based on the timespan of the query, in ms]\n\n  Templating Macros:\n  - $__escapeMulti($myTemplateVar) -&gt; $myTemplateVar should be a multi-value template variables that contains illegal characters\n  - $__contains(aColumn, $myTemplateVar) -&gt; aColumn in ($myTemplateVar)\n    If using the All option, then check the Include All Option checkbox and in the Custom all value field type in: all. If All is chosen -&gt; 1 == 1\n\n  Macro Examples:\n  - ยก where $__timeFilter()\n  - | where TimeGenerated &ge; $__timeFrom() and TimeGenerated &le; $__timeTo()\n  - | summarize count() by Category, bin(TimeGenerated, $__timeInterval)'))):null},t}(oe.PureComponent),Ke=Object(Me.stylesFactory)((function(){return{toolbar:Object(Pe.css)(de||(de=m(["\n      display: flex;\n      flex-direction: row;\n      margin-top: 4px;\n    "],["\n      display: flex;\n      flex-direction: row;\n      margin-top: 4px;\n    "])))}})),He=function(e){return ie.a.createElement("div",{className:"gf-form"},ie.a.createElement(Me.InlineFormLabel,{className:"query-keyword",width:12},e.label),e.children)},Je=function(e){return{name:e.value,type:e.type}},Ze=function(e){var t=e.value,n=e.fields,r=e.allowCustom,a=e.placeholder,o=e.templateVariableOptions,l=e.onChange,u=p(Object(oe.useState)(null),2),s=u[0],c=u[1],m=Xe(),f=Ye(n),v=Object(oe.useMemo)((function(){return f.find((function(e){return e.value===(null==t?void 0:t.name)}))}),[f,t]),h=Object(oe.useMemo)((function(){return tt(f,o)}),[f,o]),g=et(e,t,c),y=Object(oe.useCallback)((function(){!v&&s&&l(i({},s)),c(null)}),[l,c,s,v]);return ie.a.createElement("div",{className:m.container},ie.a.createElement(Me.AsyncSelect,{width:30,onChange:g,value:v,defaultOptions:o?d([o],f):f,loadOptions:h,placeholder:a,menuPlacement:"bottom",allowCustomValue:r,backspaceRemovesValue:!0,isClearable:!0,onCloseMenu:y}))},Xe=Object(Me.stylesFactory)((function(){return{container:Object(Pe.css)(me||(me=m(["\n      margin-right: 4px;\n    "],["\n      margin-right: 4px;\n    "])))}})),Ye=function(e){return Object(oe.useMemo)((function(){return e?e.map((function(e){var t;return{label:null!==(t=e.label)&&void 0!==t?t:e.value,value:e.value,type:e.type}})):[]}),[e])},et=function(e,t,n){var r=e.fields,a=e.allowCustom,o=e.templateVariableOptions,i=e.onChange;return Object(oe.useCallback)((function(e){var l;if(!e||"string"!=typeof e.value&&t){var u=T.String;return i({name:null,type:u}),void(t&&n(t))}var s=e.value,c=r.find((function(e){return e.value===s}));c||(c=null===(l=null==o?void 0:o.options)||void 0===l?void 0:l.find((function(e){return e.value===s}))),!c&&s&&a&&(c={value:s,type:T.String}),c&&i({name:c.value,type:c.type})}),[r,i,o,a,t,n])},tt=function(e,t){return function(n){return u(void 0,void 0,void 0,(function(){var r,a,o,i,l;return s(this,(function(u){return r=n.toLowerCase(),a=t?d([t],e):e,o=a.filter((function(e){var t;return null===(t=e.label)||void 0===t?void 0:t.toLowerCase().startsWith(r)})),i=a.filter((function(e){var t;return-1!==(null===(t=e.label)||void 0===t?void 0:t.toLowerCase().indexOf(r,1))})),l=o.concat(i),[2,d(new Set(l))]}))}))}},nt=function(e){return function(t){e({type:f.Property,property:t})}},rt=function(){function e(){}return e.prototype.build=function(){return e={defaultValue:this.buildFieldExpression()},function(t){var n,r=t.onChange,a=null!==(n=t.value)&&void 0!==n?n:e.defaultValue;return k(a)?ie.a.createElement(He,{label:t.label},ie.a.createElement(Ze,{fields:t.fields,templateVariableOptions:t.templateVariableOptions,onChange:nt(r),value:a.property,allowCustom:t.allowCustom}),t.children):null};var e},e.prototype.buildFieldExpression=function(){return{type:f.Property,property:{name:"",type:T.String}}},e}(),at=function(e){function t(t){var n=e.call(this,t)||this;return n.onCreate=function(e){if(e){var t=d(n.props.values,[e]);n.props.onChange({value:t,name:n.props.operator.value})}},n.onChange=function(e){Array.isArray(e)&&n.props.onChange({value:e.map((function(e){return e.value})),name:n.props.operator.value})},n.getSuggestions=function(e){return u(n,void 0,void 0,(function(){var t;return s(this,(function(n){switch(n.label){case 0:return this.setState({isLoading:!0}),[4,this.props.getSuggestions(e)];case 1:return t=n.sent(),this.setState({defaultOptions:d([this.props.templateVariableOptions],t),isLoading:!1}),[2,t]}}))}))},n.state={defaultOptions:[t.templateVariableOptions],isLoading:!1},n}return o(t,e),t.prototype.render=function(){var e=this,t=(this.props.values||[]).map((function(e){return{label:e,value:e}}));return ie.a.createElement(Me.AsyncMultiSelect,{width:30,placeholder:"Start typing to add filters...",loadOptions:this.getSuggestions,onOpenMenu:function(){return e.getSuggestions("")},defaultOptions:this.state.defaultOptions,isLoading:this.state.isLoading,value:t,onChange:this.onChange,onCreateOption:this.onCreate,noOptionsMessage:"No options found",isClearable:!0})},t}(oe.PureComponent),ot=function(e){function t(t){var n=e.call(this,t)||this;return n.onChange=function(e){null!==e?n.props.onChange({value:""+e.value,name:n.props.operator.value}):n.props.onChange({value:"",name:n.props.operator.value})},n.onCreate=function(e){e&&n.props.onChange({value:e,name:n.props.operator.value})},n.getSuggestions=function(e){return u(n,void 0,void 0,(function(){var t;return s(this,(function(n){switch(n.label){case 0:return this.setState({isLoading:!0}),[4,this.props.getSuggestions(e)];case 1:return t=n.sent(),this.setState({defaultOptions:d([this.props.templateVariableOptions],t),isLoading:!1}),[2,t]}}))}))},n.state={defaultOptions:[t.templateVariableOptions],isLoading:!1},n}return o(t,e),t.prototype.render=function(){var e=this,t=this.props.value,n=t?{label:t,value:t}:void 0;return ie.a.createElement(Me.AsyncSelect,{width:30,placeholder:"Start typing to add filters...",loadOptions:this.getSuggestions,onOpenMenu:function(){return e.getSuggestions(null!=t?t:"")},defaultOptions:this.state.defaultOptions,isLoading:this.state.isLoading,value:n,onChange:this.onChange,onCreateOption:this.onCreate,allowCustomValue:!0,backspaceRemovesValue:!0,isClearable:!0,noOptionsMessage:"No options found"})},t}(oe.PureComponent),it=[{value:!0,label:"True"},{value:!1,label:"False"}],lt=function(e){var t=Object(oe.useCallback)((function(t){t&&"boolean"==typeof t.value&&e.onChange({name:e.operator.value,value:t.value})}),[e]);return ie.a.createElement(Me.Select,{width:15,options:it,value:e.value,onChange:t,menuPlacement:"bottom"})},ut=function(e,t,n,r){if(t.multipleValues)return Array.isArray(n)?st(e,n):st(e,[n]);var a=ct(e,n);return h.a.isUndefined(a)?r:a},st=function(e,t){return t.reduce((function(t,n){var r=ct(e,n);return h.a.isUndefined(r)||t.push(r),t}),[])},ct=function(e,t){switch(e.type){case T.Boolean:return dt(t,!1);case T.Number:return pt(t,0);default:return}},pt=function(e,t){return h.a.isNumber(e)?h.a.toNumber(e):"boolean"==typeof e?e?1:0:t},dt=function(e,t){if("boolean"==typeof e)return e;if("string"==typeof e){var n=h.a.toLower(h.a.trim(e));return!!h.a.startsWith(n,"t")||!!h.a.startsWith(n,"1")}return"number"==typeof e?e>0:t},mt=function(e){var t,n=p(Object(oe.useState)(null!==(t=e.value)&&void 0!==t?t:""),2),r=n[0],a=n[1],o=e.onChange,i=e.operator.value,l=Object(oe.useCallback)((function(e){a(e.currentTarget.value)}),[a]),u=Object(oe.useCallback)((function(e){o({name:i,value:e.currentTarget.value})}),[o,i]);return ie.a.createElement(Me.Input,{width:30,value:r,onChange:l,onBlur:u})},ft=function(e){var t,n=p(Object(oe.useState)(String(null!==(t=e.value)&&void 0!==t?t:0)),2),r=n[0],a=n[1],o=e.onChange,i=e.operator.value,l=Object(oe.useCallback)((function(e){a(e.currentTarget.value)}),[a]),u=Object(oe.useCallback)((function(e){o({name:i,value:vt(e.currentTarget.value)})}),[o,i]);return ie.a.createElement(Me.Input,{width:30,value:r,onChange:l,onBlur:u})},vt=function(e){return e?isNaN(e)?0:parseInt(e,10):0},ht=function(e){return e.booleanValues?{name:e.value,value:!1}:e.multipleValues?{name:e.value,value:[]}:{name:e.value,value:""}},gt=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.onChangeOperator=function(e){if(e&&e.value){var n=t.props,r=n.property,a=n.value,o=t.props.operators.find((function(t){return t.value===e.value}));if(!o||!r)return;if(!a)return void t.props.onChange(ht(o));var i=ht(o),l=i.value,u=a.value;i.value=ut(r,o,u,l),t.props.onChange(i)}},t.onChangeValue=function(e){t.props.onChange(e)},t}return o(t,e),t.prototype.render=function(){var e=this.props,t=e.operators,n=e.value,r=e.getSuggestions,a=e.templateVariableOptions,o=e.property,u=bt(),s=t.find((function(e){return e.value===(null==n?void 0:n.name)}));return ie.a.createElement(ie.a.Fragment,null,ie.a.createElement("div",{className:u.container},ie.a.createElement(Me.Select,{isSearchable:!0,options:t,value:null==s?void 0:s.value,onChange:this.onChangeOperator,menuPlacement:"bottom",renderControl:ie.a.forwardRef((function(e,t){e.value,e.isOpen,e.invalid;var n=l(e,["value","isOpen","invalid"]);return ie.a.createElement(Me.Button,i({ref:t},n,{variant:"secondary"}),(null==s?void 0:s.label)||(null==s?void 0:s.value)||"?")}))})),yt(s,n,this.onChangeValue,r,a,null==o?void 0:o.type))},t}(oe.PureComponent),yt=function(e,t,n,r,a,o){var i;if(!e)return null;var l=bt();return function(e,t){return t===T.DateTime&&"string"==typeof(null==e?void 0:e.value)}(t,o)?ie.a.createElement("div",{className:l.container},ie.a.createElement(mt,{operator:e,value:null==t?void 0:t.value,onChange:n})):function(e,t){return t===T.Number&&"number"==typeof(null==e?void 0:e.value)}(t,o)?ie.a.createElement("div",{className:l.container},ie.a.createElement(ft,{operator:e,value:null==t?void 0:t.value,onChange:n})):!e.multipleValues||!A(t)&&t?!e.booleanValues||!function(e){return"boolean"==typeof(null==e?void 0:e.value)}(t)&&t?e.multipleValues||!function(e){return!A(e)}(t)&&t?null:ie.a.createElement("div",{className:l.container},ie.a.createElement(ot,{operator:e,value:null==t?void 0:t.value,onChange:n,getSuggestions:r,templateVariableOptions:a})):ie.a.createElement("div",{className:l.container},ie.a.createElement(lt,{operator:e,value:null==t?void 0:t.value,onChange:n})):ie.a.createElement("div",{className:l.container},ie.a.createElement(at,{operator:e,values:null!==(i=null==t?void 0:t.value)&&void 0!==i?i:[],onChange:n,getSuggestions:r,templateVariableOptions:a}))},bt=Object(Me.stylesFactory)((function(){return{container:Object(Pe.css)(fe||(fe=m(["\n      margin-right: 4px;\n      /* when Grafanas Select has labels */\n      div[class*='grafana-select-option-description'] {\n        white-space: nowrap;\n      }\n      /* fallback until Grafanas Select has labels */\n      [aria-label*='Select options menu'] {\n        div {\n          div {\n            div {\n              div {\n                div {\n                  white-space: nowrap;\n                }\n              }\n            }\n          }\n        }\n      }\n    "],["\n      margin-right: 4px;\n      /* when Grafanas Select has labels */\n      div[class*='grafana-select-option-description'] {\n        white-space: nowrap;\n      }\n      /* fallback until Grafanas Select has labels */\n      [aria-label*='Select options menu'] {\n        div {\n          div {\n            div {\n              div {\n                div {\n                  white-space: nowrap;\n                }\n              }\n            }\n          }\n        }\n      }\n    "])))}})),wt=n(8),Ct=n.n(wt),xt=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state={operators:[]},t.componentDidMount=function(){var e,n=null===(e=t.props.value)||void 0===e?void 0:e.property;n&&t.updateOperators(n)},t.updateOperators=function(e){var n,r,a=[];try{for(var o=c(t.props.operators),i=o.next();!i.done;i=o.next()){var l=i.value;l.supportTypes.includes(e.type)&&a.push(l)}}catch(e){n={error:e}}finally{try{i&&!i.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return t.setState({operators:a}),a},t.onFieldChanged=function(e){var n,r,a,o=i(i({},t.props.value),{property:e}),l=t.updateOperators(e),u=null===(n=o.operator)||void 0===n?void 0:n.name,s=l.find((function(e){return e.value===u}));if(l.length&&!s){o.operator=ht(l[0]);var c=o.operator.value,p=null===(r=t.props.value)||void 0===r?void 0:r.operator.value;o.operator.value=ut(o.property,l[0],p,c)}if(!s)return t.props.onChange(o);o.operator=ht(s);var d=o.operator.value,m=null===(a=t.props.value)||void 0===a?void 0:a.operator.value;o.operator.value=ut(o.property,s,m,d),t.props.onChange(o)},t.onOperatorChange=function(e){t.props.onChange(i(i({},t.props.value),{operator:e}))},t.getSuggestions=Ct()((function(e){return u(t,void 0,void 0,(function(){var t,n,r,a;return s(this,(function(o){switch(o.label){case 0:return this.props.value?(t=Ot(this.props.value.property,e),[4,this.props.getSuggestions(t)]):[2,[]];case 1:return n=o.sent(),Array.isArray(null===(a=this.props.templateVariableOptions)||void 0===a?void 0:a.options)&&(r=this.props.templateVariableOptions.options.filter((function(t){return"string"==typeof(null==t?void 0:t.value)&&t.value.indexOf(e)>-1})),Array.prototype.push.apply(n,r)),[2,n]}}))}))}),800,{leading:!1}),t}return o(t,e),t.prototype.render=function(){var e=this.props,t=e.value,n=e.fields,r=e.templateVariableOptions,a=this.state.operators,o=Et(),i=(null==t?void 0:t.operator)||(null==t?void 0:t.property);return ie.a.createElement("div",{className:o.container},ie.a.createElement(Ze,{value:null==t?void 0:t.property,fields:n,templateVariableOptions:r,onChange:this.onFieldChanged,placeholder:"Choose column..."}),i&&ie.a.createElement(gt,{value:null==t?void 0:t.operator,operators:a,onChange:this.onOperatorChange,getSuggestions:this.getSuggestions,property:null==t?void 0:t.property,templateVariableOptions:r}))},t}(oe.PureComponent),Et=Object(Me.stylesFactory)((function(){return{container:Object(Pe.css)(ve||(ve=m(["\n      display: flex;\n      flex-direction: row;\n    "],["\n      display: flex;\n      flex-direction: row;\n    "])))}})),Ot=function(e,t){return t?{type:f.Operator,property:e,operator:{name:"contains",value:t}}:{type:f.Operator,property:e,operator:{name:"isnotempty",value:t}}},St=function(e){var t=e.onChange,n=e.children,r=e.value,a=Object(oe.useCallback)((function(e,n){var a=d(r.expressions);n?a.splice(e,1,n):a.splice(e,1);var o=a.filter((function(e){return!("expressions"in e)||e.expressions.length>0}));t(i(i({},r),{expressions:o}))}),[t,r]);if(!(null==r?void 0:r.expressions))return null;var o=r.expressions.length;return ie.a.createElement(ie.a.Fragment,null,Array.from(r.expressions).map((function(e,t){return ie.a.createElement(ie.a.Fragment,{key:t},n({index:t,value:e,onChange:function(e){return a(t,e)},onAdd:function(e){return a(o,e)},onRemove:function(){return a(t)}}))})))},Tt=Object(Me.stylesFactory)((function(){var e=Object(Pe.css)(he||(he=m(["\n    display: flex;\n    flex-direction: row;\n  "],["\n    display: flex;\n    flex-direction: row;\n  "])));return{container:Object(Pe.css)(ge||(ge=m(["\n      display: flex;\n      flex-direction: column;\n    "],["\n      display: flex;\n      flex-direction: column;\n    "]))),row:e,rowWithSpacing:Object(Pe.css)(ye||(ye=m(["\n      ","\n      margin-top: 4px;\n    "],["\n      ","\n      margin-top: 4px;\n    "])),e),spacing:Object(Pe.css)(be||(be=m(["\n      margin-right: 4px;\n    "],["\n      margin-right: 4px;\n    "])))}})),jt=function(){function e(e,t){this.value=e,this.operators=t,this.label=e,this.types=[],this.description="",this.multiple=!1,this.bool=!1}return e.prototype.withLabel=function(e){return this.label=e,this},e.prototype.withDescription=function(e){return this.description=e,this},e.prototype.supportTypes=function(e){return this.types=e,this},e.prototype.multipleValues=function(e){return this.multiple=e,this},e.prototype.booleanValues=function(e){return this.bool=e,this},e.prototype.add=function(){this.operators.push({value:this.value,supportTypes:this.types,label:this.label,description:this.description,multipleValues:this.multiple,booleanValues:this.bool})},e}(),Ft=function(){function e(){this.operators=[]}return e.prototype.withOperators=function(e){var t=this;return e((function(e){return new jt(e,t.operators)})),this},e.prototype.withMultipleRows=function(e){return this},e.prototype.build=function(){return e={operators:this.operators,defaultValue:this.buildOperatorExpression()},function(t){var n,r,a=Tt();return 0===(null===(r=null===(n=t.value)||void 0===n?void 0:n.expressions)||void 0===r?void 0:r.length)?ie.a.createElement(He,{label:t.label},ie.a.createElement(Me.Button,{variant:"secondary",onClick:function(){var n=i(i({},t.value),{expressions:[{type:f.Or,expressions:[e.defaultValue]}]});t.onChange(n)},icon:"plus"})):ie.a.createElement(St,{id:"filter-and",value:t.value,onChange:t.onChange},(function(n){var r,o;return M(n.value)?0===(null===(o=null===(r=n.value)||void 0===r?void 0:r.expressions)||void 0===o?void 0:o.length)?n.index>0?null:ie.a.createElement(He,{label:t.label},ie.a.createElement(Me.Button,{variant:"secondary",onClick:function(){var t={type:f.Or,expressions:[e.defaultValue]};n.onChange(t)},icon:"plus"})):ie.a.createElement(He,{label:t.label},ie.a.createElement("div",{className:a.container},ie.a.createElement(St,{id:"filter-or",value:n.value,onChange:n.onChange},(function(r){if(!V(r.value))return console.log("invalid fieldandoperator-expression"),null;var o,u=0===r.index,s=u?a.row:a.rowWithSpacing;return ie.a.createElement("div",{className:s},!u&&ie.a.createElement(Me.InlineFormLabel,{className:"query-keyword",width:3},"or"),ie.a.createElement(xt,{value:r.value,operators:e.operators,fields:t.fields,templateVariableOptions:t.templateVariableOptions,onChange:r.onChange,getSuggestions:(o=n.index+"-"+r.index,function(e){return t.getSuggestions(o,e)})}),ie.a.createElement("div",{className:a.spacing},ie.a.createElement(Me.Button,{variant:"secondary",onClick:r.onRemove,icon:"minus"})),u&&ie.a.createElement(Me.Select,{isSearchable:!0,options:[{value:"append-row",label:"OR - include another option"},{value:"new-row",label:'AND - add a new "'+t.label+'" clause'}],onChange:function(t){return"append-row"===(null==t?void 0:t.value)?r.onAdd(e.defaultValue):"new-row"===(null==t?void 0:t.value)?n.onAdd({type:f.Or,expressions:[e.defaultValue]}):void 0},menuPlacement:"bottom",renderControl:ie.a.forwardRef((function(e,t){e.value,e.isOpen,e.invalid;var n=l(e,["value","isOpen","invalid"]);return ie.a.createElement(Me.Button,i({ref:t},n,{variant:"secondary",icon:"plus"}))}))}))})))):null}))};var e},e.prototype.buildOperatorExpression=function(){var e=this.operators[0];return{type:f.Operator,property:this.buildFieldExpression(),operator:ht(e)}},e.prototype.buildFieldExpression=function(){return{name:"",type:T.String}},e}(),Dt=function(e){var t,n=p(Object(oe.useState)(null!==(t=e.value)&&void 0!==t?t:""),2),r=n[0],a=n[1],o=Object(oe.useCallback)((function(e){e&&e.currentTarget&&a(e.currentTarget.value)}),[a]),i=Object(oe.useCallback)((function(){e.onChange({type:f.FunctionParameter,fieldType:e.fieldType,value:r,name:e.name})}),[r,e]);return ie.a.createElement(Me.Input,{width:20,value:r,placeholder:e.description,onChange:o,onBlur:i})},kt=function(e){var t,n,r,a,o=e.value,i=e.functions,l=e.onChange,u=p(Object(oe.useState)(null===(t=e.value)||void 0===t?void 0:t.property),2),s=u[0],c=u[1],d=p(Object(oe.useState)(null===(n=e.value)||void 0===n?void 0:n.reduce),2),m=d[0],v=d[1],h=p(Object(oe.useState)(null===(r=e.value)||void 0===r?void 0:r.parameters),2),g=h[0],y=h[1],b=At(m,e.functions),w=Vt(),C=Object(oe.useCallback)((function(e){var t;if(c(e),!(null===(t=null==o?void 0:o.reduce)||void 0===t?void 0:t.name)){var n=i.find((function(e){return"avg"===e.value}));n||(n=i[0]),v({name:n.value,type:T.Function})}}),[c,o,i]),x=Object(oe.useCallback)((function(e){v(e)}),[v]),E=Object(oe.useCallback)((function(e){y(e)}),[y]);Object(oe.useEffect)((function(){if(s&&m){var e={type:f.Reduce,property:s,reduce:m,parameters:g};l(e)}}),[s,m,g]);var O=Nt(m,e.functions);return ie.a.createElement("div",{className:w.container},ie.a.createElement(Ze,{value:m,fields:e.functions,onChange:x,placeholder:"Choose aggregation function..."}),O.length>0&&ie.a.createElement("div",{className:w.params},O.map((function(t){var n,r,a;return ie.a.createElement(Dt,{key:t.name,name:t.name,value:null===(a=null===(r=null===(n=e.value)||void 0===n?void 0:n.parameters)||void 0===r?void 0:r.find((function(e){return e.name===t.name})))||void 0===a?void 0:a.value,description:t.description,fieldType:t.type,onChange:function(e){return E([e])}})}))),b&&ie.a.createElement(ie.a.Fragment,null,ie.a.createElement(Me.InlineFormLabel,{width:2,className:"query-keyword"},null!==(a=e.label)&&void 0!==a?a:"of"),ie.a.createElement(Ze,{value:s,fields:e.fields,templateVariableOptions:e.templateVariableOptions,onChange:C,placeholder:"Choose column..."})))},Vt=Object(Me.stylesFactory)((function(){return{container:Object(Pe.css)(we||(we=m(["\n      display: flex;\n      flex-direction: row;\n    "],["\n      display: flex;\n      flex-direction: row;\n    "]))),params:Object(Pe.css)(Ce||(Ce=m(["\n      margin-right: 4px;\n    "],["\n      margin-right: 4px;\n    "])))}})),Nt=function(e,t){if(!e)return[];var n=t.find((function(t){return t.value===e.name}));return(null==n?void 0:n.parameters)||[]},At=function(e,t){return Object(oe.useMemo)((function(){var n,r,a;if(!e)return null===(r=null===(n=t[0])||void 0===n?void 0:n.applyOnField)||void 0===r||r;var o=t.find((function(t){return t.value===e.name}));return null===(a=null==o?void 0:o.applyOnField)||void 0===a||a}),[t,e])},_t=Object(Me.stylesFactory)((function(){var e=Object(Pe.css)(xe||(xe=m(["\n    display: flex;\n    flex-direction: row;\n  "],["\n    display: flex;\n    flex-direction: row;\n  "])));return{container:Object(Pe.css)(Ee||(Ee=m(["\n      display: flex;\n      flex-direction: column;\n    "],["\n      display: flex;\n      flex-direction: column;\n    "]))),row:e,rowWithSpacing:Object(Pe.css)(Oe||(Oe=m(["\n      ","\n      margin-top: 4px;\n    "],["\n      ","\n      margin-top: 4px;\n    "])),e),spacing:Object(Pe.css)(Se||(Se=m(["\n      margin-right: 4px;\n    "],["\n      margin-right: 4px;\n    "])))}})),Mt=function(){function e(e,t){this.value=e,this.functions=t,this.appliedOnField=!0,this.parameters=[],this.label=e}return e.prototype.withLabel=function(e){return this.label=e,this},e.prototype.withParameter=function(e,t,n){return this.parameters.push({name:e,type:t,description:n}),this},e.prototype.isAppliedOnField=function(e){return this.appliedOnField=e,this},e.prototype.add=function(){this.functions.push({value:this.value,label:this.label,type:T.Function,parameters:this.parameters,applyOnField:this.appliedOnField})},e}(),Pt=function(){function e(){this.functions=[]}return e.prototype.withMultipleRows=function(e){return this},e.prototype.withFunctions=function(e){var t=this;return e((function(e){return new Mt(e,t.functions)})),this},e.prototype.build=function(){return e={functions:this.functions,defaultValue:this.buildReduceExpression()},function(t){var n=_t();return 0===t.value.expressions.length?ie.a.createElement(He,{label:t.label},ie.a.createElement(Me.Button,{variant:"secondary",onClick:function(){var n=i(i({},t.value),{expressions:[e.defaultValue]});t.onChange(n)},icon:"plus"})):ie.a.createElement(He,{label:t.label},ie.a.createElement("div",{className:n.container},ie.a.createElement(St,{id:"reduce",onChange:t.onChange,value:t.value},(function(r){if(!D(r.value))return null;var a=0===r.index,o=a?n.row:n.rowWithSpacing;return ie.a.createElement("div",{className:o},ie.a.createElement(kt,{onChange:r.onChange,value:r.value,templateVariableOptions:t.templateVariableOptions,fields:t.fields,functions:e.functions}),ie.a.createElement(Me.Button,{className:n.spacing,variant:"secondary",onClick:r.onRemove,icon:"minus"}),a&&ie.a.createElement(Me.Button,{variant:"secondary",onClick:function(){return r.onAdd(e.defaultValue)},icon:"plus"}))}))))};var e},e.prototype.buildReduceExpression=function(){return{type:f.Reduce,property:this.buildProperty(T.String),reduce:this.buildProperty(T.Function)}},e.prototype.buildProperty=function(e){return{name:"",type:e}},e}(),It=function(e){var t,n,r=e.intervals,a=e.onChange,o=p(Object(oe.useState)(null===(t=e.value)||void 0===t?void 0:t.property),2),i=o[0],l=o[1],u=p(Object(oe.useState)(null===(n=e.value)||void 0===n?void 0:n.interval),2),s=u[0],c=u[1],d=qt(),m=Object(oe.useCallback)((function(e){l(e),e.type===T.DateTime&&c({type:T.Interval,name:r[0].value})}),[l,r]),v=Object(oe.useCallback)((function(e){c(e)}),[c]);return Object(oe.useEffect)((function(){if(i){var e={type:f.GroupBy,property:i,interval:s};a(e)}}),[i,s]),ie.a.createElement("div",{className:d.container},ie.a.createElement(Ze,{value:i,fields:e.fields,templateVariableOptions:e.templateVariableOptions,onChange:m,placeholder:"Choose column..."}),(null==i?void 0:i.type)===T.DateTime&&ie.a.createElement(Ze,{value:s,fields:e.intervals,templateVariableOptions:e.templateVariableOptions,onChange:v,placeholder:"Choose interval",allowCustom:!0}))},qt=Object(Me.stylesFactory)((function(){return{container:Object(Pe.css)(Te||(Te=m(["\n      display: flex;\n      flex-direction: row;\n    "],["\n      display: flex;\n      flex-direction: row;\n    "])))}})),Rt=Object(Me.stylesFactory)((function(){var e=Object(Pe.css)(je||(je=m(["\n    display: flex;\n    flex-direction: row;\n  "],["\n    display: flex;\n    flex-direction: row;\n  "])));return{container:Object(Pe.css)(Fe||(Fe=m(["\n      display: flex;\n      flex-direction: column;\n    "],["\n      display: flex;\n      flex-direction: column;\n    "]))),row:e,rowWithSpacing:Object(Pe.css)(De||(De=m(["\n      ","\n      margin-top: 4px;\n    "],["\n      ","\n      margin-top: 4px;\n    "])),e),spacing:Object(Pe.css)(ke||(ke=m(["\n      margin-right: 4px;\n    "],["\n      margin-right: 4px;\n    "])))}})),Bt=function(){function e(e,t){this.value=e,this.intervals=t,this.label=e}return e.prototype.withLabel=function(e){return this.label=e,this},e.prototype.add=function(){this.intervals.push({value:this.value,label:this.label,type:T.Interval})},e}(),Lt=function(){function e(){this.intervals=[]}return e.prototype.withMultipleRows=function(e){return this},e.prototype.withIntervals=function(e){var t=this;return e((function(e){return new Bt(e,t.intervals)})),this},e.prototype.build=function(){return e={intervals:this.intervals,defaultValue:this.buildGroupByExpressions()},function(t){var n=Rt();return 0===t.value.expressions.length?ie.a.createElement(He,{label:t.label},ie.a.createElement(Me.Button,{variant:"secondary",onClick:function(){var n=i(i({},t.value),{expressions:[e.defaultValue]});t.onChange(n)},icon:"plus"})):ie.a.createElement(He,{label:t.label},ie.a.createElement("div",{className:n.container},ie.a.createElement(St,{id:"group-by",onChange:t.onChange,value:t.value},(function(r){if(!N(r.value))return null;var a=0===r.index,o=a?n.row:n.rowWithSpacing;return ie.a.createElement("div",{className:o},ie.a.createElement(It,{onChange:r.onChange,value:r.value,templateVariableOptions:t.templateVariableOptions,fields:t.fields,intervals:e.intervals}),ie.a.createElement(Me.Button,{className:n.spacing,variant:"secondary",onClick:r.onRemove,icon:"minus"}),a&&ie.a.createElement(Me.Button,{variant:"secondary",onClick:function(){return r.onAdd(e.defaultValue)},icon:"plus"}))}))))};var e},e.prototype.buildGroupByExpressions=function(){return{type:f.GroupBy,property:{name:"",type:T.String}}},e}(),$t=function(e){return e.build()}(new rt),zt=function(e){return e(new Ft)}((function(e){return e.withOperators((function(e){e("==").supportTypes([T.String,T.Number,T.DateTime]).withDescription("equal to").add(),e("==").supportTypes([T.Boolean]).withDescription("equal to").booleanValues(!0).add(),e("!=").supportTypes([T.String,T.Number,T.DateTime]).withDescription("not equal to").add(),e("!=").supportTypes([T.Boolean]).withDescription("not equal to").booleanValues(!0).add(),e(">").supportTypes([T.Number,T.DateTime]).withDescription("greater than").add(),e("<").supportTypes([T.Number,T.DateTime]).withDescription("less than").add(),e("=~").supportTypes([T.String]).withDescription("equal to (case-insensitive)").add(),e("!~").supportTypes([T.String]).withDescription("not equal to (case-insensitive)").add(),e("in").supportTypes([T.String]).withDescription("in (case-sensitive)").multipleValues(!0).add(),e("in~").supportTypes([T.String]).withDescription("in (case-insensitive)").multipleValues(!0).add(),e("!in").supportTypes([T.String]).withDescription("not in (case-sensitive)").multipleValues(!0).add(),e("!in~").supportTypes([T.String]).withDescription("not in (case-insensitive)").multipleValues(!0).add(),e("contains").supportTypes([T.String]).withDescription("contains substring").multipleValues(!1).add(),e("!contains").supportTypes([T.String]).withDescription("does not contain substring").multipleValues(!1).add(),e("contains_cs").supportTypes([T.String]).withDescription("contains substring (case-sensitive)").multipleValues(!1).add(),e("!contains_cs").supportTypes([T.String]).withDescription("does not contain substring (case-sensitive)").multipleValues(!1).add(),e("endswith").supportTypes([T.String]).withDescription("ends with").multipleValues(!1).add(),e("!endswith").supportTypes([T.String]).withDescription("does not end with").multipleValues(!1).add(),e("endswith_cs").supportTypes([T.String]).withDescription("ends with (case-sensitive)").multipleValues(!1).add(),e("!endswith_cs").supportTypes([T.String]).withDescription("does not end with (case-sensitive)").multipleValues(!1).add(),e("startswith").supportTypes([T.String]).withDescription("starts with").multipleValues(!1).add(),e("!startsswith").supportTypes([T.String]).withDescription("does not start with").multipleValues(!1).add(),e("startswith_cs").supportTypes([T.String]).withDescription("starts with (case-sensitive)").multipleValues(!1).add(),e("!startswith_cs").supportTypes([T.String]).withDescription("does not start with (case-sensitive)").multipleValues(!1).add(),e("matches regex").supportTypes([T.String]).withDescription("regex string matching").multipleValues(!1).add(),e("has_any").supportTypes([T.String]).withDescription("any provided values matching").multipleValues(!0).add(),e("has").supportTypes([T.String]).withDescription("match if whole term exists in column").multipleValues(!1).add(),e("!has").supportTypes([T.String]).withDescription("match if whole term not exists in column").multipleValues(!1).add()})).withMultipleRows(!0).build()})),Wt=function(e){return e(new Pt)}((function(e){return e.withFunctions((function(e){e("sum").withLabel("Sum").add(),e("avg").withLabel("Avg").add(),e("count").isAppliedOnField(!1).withLabel("Count").add(),e("dcount").withLabel("Dcount").add(),e("max").withLabel("Max").add(),e("min").withLabel("Min").add(),e("percentile").withLabel("Percentile").withParameter("percentileParam",T.Number,"percentile constant").add()})).withMultipleRows(!0).build()})),Qt=function(e){return e(new Lt)}((function(e){return e.withIntervals((function(e){e("$__timeInterval").withLabel("auto").add(),e("1m").withLabel("1 minute").add(),e("5m").withLabel("5 minutes").add(),e("15m").withLabel("15 minutes").add(),e("30m").withLabel("30 minutes").add(),e("1h").withLabel("1 hour").add(),e("6h").withLabel("6 hours").add(),e("12h").withLabel("12 hours").add(),e("1d").withLabel("1 day").add()})).withMultipleRows(!0).build()})),Gt=function(){function e(e){this.datasource=e}return e.prototype.createCacheKey=function(e){return"AdxSchemaResolver."+this.datasource.id+"."+e},e.prototype.getDatabases=function(){return u(this,void 0,Promise,(function(){var e;return s(this,(function(t){switch(t.label){case 0:return[4,this.datasource.getSchema()];case 1:return e=t.sent(),[2,Object.keys(e.Databases).map((function(t){return e.Databases[t]}))]}}))}))},e.prototype.getTablesForDatabase=function(e){return u(this,void 0,Promise,(function(){var t,n;return s(this,(function(r){switch(r.label){case 0:return[4,this.getDatabases()];case 1:return t=r.sent(),(n=t.find((function(t){return t.Name===e})))?[2,Object.keys(n.Tables).map((function(e){return n.Tables[e]}))]:[2,[]]}}))}))},e.prototype.getViewsForDatabase=function(e){return u(this,void 0,Promise,(function(){var t,n;return s(this,(function(r){switch(r.label){case 0:return[4,this.getDatabases()];case 1:return t=r.sent(),(n=t.find((function(t){return t.Name===e})))?[2,Object.keys(n.MaterializedViews).map((function(e){return n.MaterializedViews[e]}))]:[2,[]]}}))}))},e.prototype.getFunctionsForDatabase=function(e){return u(this,void 0,Promise,(function(){var t,n;return s(this,(function(r){switch(r.label){case 0:return[4,this.getDatabases()];case 1:return t=r.sent(),(n=t.find((function(t){return t.Name===e})))?[2,Object.keys(n.Functions).map((function(e){return n.Functions[e]}))]:[2,[]]}}))}))},e.prototype.getColumnsForTable=function(e,t){return u(this,void 0,Promise,(function(){var n,r,a=this;return s(this,(function(o){return n=this.createCacheKey("db."+e+"."+t),r=this.datasource.getSchemaMapper(),[2,F(n,(function(){return u(a,void 0,void 0,(function(){var n,a,o,i,l,u;return s(this,(function(s){switch(s.label){case 0:return n=r.getMappingByValue(t),[4,this.findSchema(e,t,n)];case 1:return(a=s.sent())?(null==n?void 0:n.type)!==C.function?[3,3]:(o=a,[4,this.datasource.getFunctionSchema(e,n.value)]):[2,[]];case 2:o.OrderedColumns=s.sent(),s.label=3;case 3:return i=a.OrderedColumns.filter((function(e){return"dynamic"===e.CslType})).map((function(e){return e.Name})),[4,this.datasource.getDynamicSchema(e,null!==(u=null==n?void 0:n.name)&&void 0!==u?u:t,i)];case 4:return l=s.sent(),[2,a.OrderedColumns.reduce((function(e,t){var n=l[t.Name];return Array.isArray(n)?(Array.prototype.push.apply(e,n),e):(e.push(t),e)}),[])]}}))}))}))]}))}))},e.prototype.findSchema=function(e,t,n){var r;return u(this,void 0,Promise,(function(){var a,o,i,l,u,c,d,m;return s(this,(function(s){switch(s.label){case 0:return[4,Promise.all([this.getTablesForDatabase(e),this.getFunctionsForDatabase(e),this.getViewsForDatabase(e)])];case 1:return a=p.apply(void 0,[s.sent(),3]),o=a[0],i=a[1],l=a[2],u=null!==(r=null==n?void 0:n.name)&&void 0!==r?r:t,(c=o.find((function(e){return e.Name===u})))?[2,c]:(d=l.find((function(e){return e.Name===u})))?[2,d]:(m=i.find((function(e){return e.Name===u})))?[2,{Name:m.Name,OrderedColumns:m.OutputColumns}]:[2]}}))}))},e}(),Ut=function(e){var t=Object(Me.useTheme)(),n=Jt(t);return ie.a.createElement("div",{className:n.container},ie.a.createElement("div",{className:n.icon},ie.a.createElement(Me.Icon,{className:"spin-clockwise",name:"sync"})),ie.a.createElement("span",null,"One moment, your schema is loading ..."))},Kt=function(e){var t=Object(Me.useTheme)(),n=Jt(t);return ie.a.createElement("div",{className:n.container},ie.a.createElement("div",{className:n.icon},ie.a.createElement(Me.Icon,{name:"exclamation-triangle",className:n.error})),ie.a.createElement("span",{className:n.error},e.message))},Ht=function(e){var t=Object(Me.useTheme)(),n=Jt(t);return ie.a.createElement("div",{className:n.container},ie.a.createElement("div",{className:n.icon},ie.a.createElement(Me.Icon,{name:"exclamation-triangle",className:n.warning})),ie.a.createElement("span",{className:n.warning},e.message))},Jt=Object(Me.stylesFactory)((function(e){return{container:Object(Pe.css)(Ve||(Ve=m(["\n      margin-top: 10px;\n      display: flex;\n      flex-direction: row;\n    "],["\n      margin-top: 10px;\n      display: flex;\n      flex-direction: row;\n    "]))),icon:Object(Pe.css)(Ne||(Ne=m(["\n      margin-right: 4px;\n    "],["\n      margin-right: 4px;\n    "]))),error:Object(Pe.css)(Ae||(Ae=m(["\n      color: ",";\n    "],["\n      color: ",";\n    "])),e.colors.formInputBorderInvalid),warning:Object(Pe.css)(_e||(_e=m(["\n      color: ",";\n    "],["\n      color: ",";\n    "])),e.palette.yellow)}})),Zt=function(e){var t,n,r,a,o,l,c,p,d,m,f,v,h,y,b,w=e.query,C=e.database,E=e.datasource,O=e.schema,S=e.onChangeQuery,T=E.id,j=E.parseExpression,F=E.autoCompleteQuery,D=E.getSchemaMapper,V=Qe(w.resultFormat),N=Object(g.getTemplateSrv)().replace(C),A=nn(O,N,E),_=tn(A,w,E),M=Object(g.getTemplateSrv)().replace(null!==(t=null==_?void 0:_.property.name)&&void 0!==t?t:""),P=D().getMappingByValue(null==_?void 0:_.property.name),I=ln(),q=se((function(){return u(void 0,void 0,void 0,(function(){var e,t,n,r,a,o,l;return s(this,(function(u){switch(u.label){case 0:return _&&_.property?(e=null!==(a=null==P?void 0:P.value)&&void 0!==a?a:M,[4,rn(E,N,e)]):[2,[]];case 1:return t=u.sent(),n=null!==(o=w.expression)&&void 0!==o?o:x.expression,r=null!==(l=n.from)&&void 0!==l?l:_,S(i(i({},w),{query:j(i(i({},n),{from:r}),t)})),[2,t]}}))}))}),[T,N,M,null==P?void 0:P.value]),R=Object(oe.useCallback)((function(e,t){return u(void 0,void 0,void 0,(function(){return s(this,(function(n){switch(n.label){case 0:return[4,F({search:t,database:N,expression:w.expression,index:e},q.value)];case 1:return[2,n.sent().map((function(e){return{value:e,label:e}}))]}}))}))}),[F,N,q.value,w.expression]),B=en(q.value),L=Yt(B),$=Object(oe.useCallback)((function(e){if(k(e)&&_){var t=i(i({},x.expression),{from:e});S(i(i({},w),{resultFormat:V,database:C,expression:t}))}}),[S,w,V,C,_]),z=Object(oe.useCallback)((function(e){var t=i(i({},w.expression),{from:_,where:e});S(i(i({},w),{resultFormat:V,database:C,expression:t,query:j(t,q.value)}))}),[S,w,q.value,V,C,_,j]),W=Object(oe.useCallback)((function(e){var t=i(i({},w.expression),{from:_,reduce:e});S(i(i({},w),{resultFormat:V,database:C,expression:t,query:j(t,q.value)}))}),[S,w,q.value,V,C,_,j]),Q=Object(oe.useCallback)((function(e){var t=i(i({},w.expression),{from:_,groupBy:e});S(i(i({},w),{resultFormat:V,database:C,expression:t,query:j(t,q.value)}))}),[S,w,q.value,V,C,_,j]),G=Object(oe.useCallback)((function(e){var t=i(i({},w.expression),{from:_});S(i(i({},w),{expression:t,database:C,resultFormat:e}))}),[S,_,C,w]),U=Object(oe.useCallback)((function(e){if(k(e)&&_){var t=i(i(i({},x.expression),w.expression),{from:_,timeshift:e});S(i(i({},w),{resultFormat:V,database:C,expression:t,query:j(t,q.value)}))}}),[S,w,V,C,_,j,q.value]);if(q.loading)return ie.a.createElement(ie.a.Fragment,null,ie.a.createElement($t,{templateVariableOptions:e.templateVariableOptions,label:"From",value:_,fields:A,onChange:$}),ie.a.createElement(Ut,null));if(q.error)return ie.a.createElement(ie.a.Fragment,null,ie.a.createElement($t,{templateVariableOptions:e.templateVariableOptions,label:"From",value:_,fields:A,onChange:$}),ie.a.createElement(Kt,{message:"Could not load table schema: "+(null===(n=q.error)||void 0===n?void 0:n.message)}));if(0===(null===(r=q.value)||void 0===r?void 0:r.length))return ie.a.createElement(ie.a.Fragment,null,ie.a.createElement($t,{templateVariableOptions:e.templateVariableOptions,label:"From",value:_,fields:A,onChange:$}),ie.a.createElement(Ht,{message:"Table schema loaded successfully but without any columns"}));var K=Xt();return ie.a.createElement(ie.a.Fragment,null,ie.a.createElement($t,{templateVariableOptions:e.templateVariableOptions,label:"From",value:_,fields:A,onChange:$},ie.a.createElement(ze,{format:V,includeAdxTimeFormat:!1,onChangeFormat:G})),ie.a.createElement(zt,{templateVariableOptions:e.templateVariableOptions,label:"Where (filter)",value:null!==(o=null===(a=w.expression)||void 0===a?void 0:a.where)&&void 0!==o?o:null===(l=x.expression)||void 0===l?void 0:l.where,fields:B,onChange:z,getSuggestions:R}),ie.a.createElement(Wt,{templateVariableOptions:e.templateVariableOptions,label:"Aggregate",value:null!==(p=null===(c=w.expression)||void 0===c?void 0:c.reduce)&&void 0!==p?p:null===(d=x.expression)||void 0===d?void 0:d.reduce,fields:B,onChange:W}),ie.a.createElement(Qt,{templateVariableOptions:e.templateVariableOptions,label:"Group by",value:null!==(f=null===(m=w.expression)||void 0===m?void 0:m.groupBy)&&void 0!==f?f:null===(v=x.expression)||void 0===v?void 0:v.groupBy,fields:L,onChange:Q}),ie.a.createElement("hr",null),ie.a.createElement($t,{templateVariableOptions:[],label:"Timeshift",value:null!==(y=null===(h=w.expression)||void 0===h?void 0:h.timeshift)&&void 0!==y?y:null===(b=x.expression)||void 0===b?void 0:b.timeshift,fields:I,onChange:U,allowCustom:!0}),ie.a.createElement("div",{className:K.query},ie.a.createElement(Me.TextArea,{cols:80,rows:8,value:e.query.query,disabled:!0})))},Xt=Object(Me.stylesFactory)((function(){return{query:Object(Pe.css)(an||(an=m(["\n      margin-top: 12px;\n    "],["\n      margin-top: 12px;\n    "])))}})),Yt=function(e){return Object(oe.useMemo)((function(){return e.filter((function(e){return e.type===T.DateTime||T.String}))}),[e])},en=function(e){return Object(oe.useMemo)((function(){return e?(t=e,Array.isArray(t)?t.map((function(e){return{value:e.Name,label:e.Name,type:G(e.CslType)}})):[]):[];var t}),[e])},tn=function(e,t,n){var r,a,o=n.getVariables(),i=null===(a=null===(r=t.expression)||void 0===r?void 0:r.from)||void 0===a?void 0:a.property.name;return Object(oe.useMemo)((function(){var t=e.find((function(e){return e.value===i}));if(t)return{type:f.Property,property:Je(t)};var n=o.find((function(e){return e===i}));return n?{type:f.Property,property:{name:n,type:T.String}}:e.length>0?{type:f.Property,property:Je(e[0])}:void 0}),[e,i,o])},nn=function(e,t,n){var r=n.getSchemaMapper();return Object(oe.useMemo)((function(){return e&&e.Databases?r.getTableOptions(e,t):[]}),[t,e,r])};function rn(e,t,n){return u(this,void 0,void 0,(function(){return s(this,(function(r){switch(r.label){case 0:return[4,new Gt(e).getColumnsForTable(t,n)];case 1:return[2,r.sent()]}}))}))}var an,on,ln=function(){return Object(oe.useMemo)((function(){return[{label:"No timeshift",value:"",type:T.TimeSpan},{label:"Hour before",value:"1h",type:T.TimeSpan},{label:"Day before",value:"1d",type:T.TimeSpan},{label:"Week before",value:"7d",type:T.TimeSpan}]}),[])},un=function(e){var t=e.dirty,n=e.editorMode,r=e.onToggleEditorMode,a=p(Object(oe.useState)(!1),2),o=a[0],i=a[1],l=Object(oe.useCallback)((function(){t&&n!==b.Visual?i(!0):r()}),[i,r,t,n]),u=sn();return ie.a.createElement(He,{label:"Database"},ie.a.createElement(Me.Select,{width:30,options:e.databases,placeholder:"Select database",value:e.database,onChange:function(t){t&&t.value&&e.onChangeDatabase(t.value)}}),e.editorMode===b.Raw&&ie.a.createElement(ie.a.Fragment,null,ie.a.createElement("div",{className:u.spacing}),ie.a.createElement("label",{className:"gf-form-label"},"(Run Query: Shift+Enter, Trigger Suggestion: Ctrl+Space)")),ie.a.createElement("div",{className:"gf-form gf-form--grow"},ie.a.createElement("div",{className:"gf-form-label--grow"})),ie.a.createElement(Me.Button,{variant:"secondary",onClick:l},e.editorMode===b.Visual?"Edit KQL":"Switch to builder"),ie.a.createElement("div",{className:u.spacing}),ie.a.createElement(Me.Button,{variant:e.dirty?"primary":"secondary",onClick:e.onRunQuery},"Run Query"),ie.a.createElement(Me.ConfirmModal,{isOpen:o,title:"Are you sure?",body:"You might lose manual changes done to the query if you go back to the visual builder.",confirmText:"Yes, I am sure.",dismissText:"No, continue edit query manually.",icon:"exclamation-triangle",onConfirm:function(){i(!1),e.onToggleEditorMode()},onDismiss:function(){return i(!1)}}))},sn=Object(Me.stylesFactory)((function(){return{spacing:Object(Pe.css)(on||(on=m(["\n      margin-right: 4px;\n    "],["\n      margin-right: 4px;\n    "])))}}));function cn(e){return(cn="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var pn=function(e){var t,n;return"string"==typeof(null===(n=null===(t=null==e?void 0:e.from)||void 0===t?void 0:t.expression)||void 0===n?void 0:n.value)},dn=function(e){var t,n,r,a,o,l,u,s,c,p,d,m,v,h,g;if(!e)return x.expression;var y=i({},x.expression);return"string"==typeof(null===(n=null===(t=null==e?void 0:e.from)||void 0===t?void 0:t.expression)||void 0===n?void 0:n.value)&&(y.from=gn(null===(r=null==e?void 0:e.from)||void 0===r?void 0:r.expression)),Array.isArray(null===(o=null===(a=null==e?void 0:e.where)||void 0===a?void 0:a.expression)||void 0===o?void 0:o.expressions)&&(y.where={type:f.And,expressions:null===(u=null===(l=null==e?void 0:e.where)||void 0===l?void 0:l.expression)||void 0===u?void 0:u.expressions.map(fn).filter((function(e){return!!e})).map((function(e){return{type:f.Or,expressions:[e]}}))}),Array.isArray(null===(c=null===(s=null==e?void 0:e.reduce)||void 0===s?void 0:s.expression)||void 0===c?void 0:c.expressions)&&(y.reduce=mn(null===(d=null===(p=null==e?void 0:e.reduce)||void 0===p?void 0:p.expression)||void 0===d?void 0:d.expressions)),Array.isArray(null===(v=null===(m=null==e?void 0:e.groupBy)||void 0===m?void 0:m.expression)||void 0===v?void 0:v.expressions)&&(y.groupBy=mn(null===(g=null===(h=null==e?void 0:e.groupBy)||void 0===h?void 0:h.expression)||void 0===g?void 0:g.expressions)),y},mn=function(e){return Array.isArray(e)?{type:f.And,expressions:e.map(fn).filter((function(e){return!!e}))}:{type:f.And,expressions:[]}},fn=function(e){switch(null==e?void 0:e.type){case"fieldAndOperator":return yn(e);case"field":return gn(e);case"reduce":return hn(e);case"groupBy":return vn(e);default:return}},vn=function(e){if("groupBy"===(null==e?void 0:e.type)&&"object"===cn(null==e?void 0:e.field))return"object"!==cn(null==e?void 0:e.interval)?{type:f.GroupBy,property:bn(null==e?void 0:e.field)}:{type:f.GroupBy,property:bn(null==e?void 0:e.field),interval:bn(null==e?void 0:e.interval)}},hn=function(e){if("reduce"===(null==e?void 0:e.type)&&"object"===cn(null==e?void 0:e.field))return Array.isArray(null==e?void 0:e.parameters)?{type:f.Reduce,property:bn(null==e?void 0:e.field),reduce:bn(null==e?void 0:e.reduce),parameters:e.parameters}:{type:f.Reduce,property:bn(null==e?void 0:e.field),reduce:bn(null==e?void 0:e.reduce)}},gn=function(e){if("field"===(null==e?void 0:e.type)&&"string"==typeof(null==e?void 0:e.value))return{type:f.Property,property:bn(e)}},yn=function(e){var t,n,r,a,o,i,l,u;if("string"==typeof(null===(t=null==e?void 0:e.field)||void 0===t?void 0:t.value)&&"string"==typeof(null===(r=null===(n=null==e?void 0:e.operator)||void 0===n?void 0:n.operator)||void 0===r?void 0:r.value))return{type:f.Operator,property:bn(null==e?void 0:e.field),operator:{name:null===(o=null===(a=null==e?void 0:e.operator)||void 0===a?void 0:a.operator)||void 0===o?void 0:o.value,value:null!==(l=null===(i=null==e?void 0:e.operator)||void 0===i?void 0:i.value)&&void 0!==l?l:null===(u=null==e?void 0:e.operator)||void 0===u?void 0:u.values}}},bn=function(e){return{type:wn(e.fieldType),name:e.value}},wn=function(e){switch(e){case"boolean":return T.Boolean;case"dateTime":return T.DateTime;case"function":return T.Function;case"number":return T.Number;case"interval":return T.Interval;default:return T.String}};function Cn(e){var t;return!(void 0!==e.rawMode||!e.query||(null===(t=e.expression)||void 0===t?void 0:t.from))||(e.rawMode||!1)}var xn=function(e,t,n){var r=n.getVariables();return Object(oe.useMemo)((function(){var n=e.find((function(e){return e.value===t.database}));if(n)return n.value;var a=r.find((function(e){return e===t.database}));return a||(e.length>0?e[0].value:"")}),[e,r,t.database])},En=function(e){return Object(oe.useMemo)((function(){var t,n,r=[];if(!e||!e.Databases)return r;try{for(var a=c(Object.keys(e.Databases)),o=a.next();!o.done;o=a.next()){var i=o.value,l=e.Databases[i];r.push(Q(l))}}catch(e){t={error:e}}finally{try{o&&!o.done&&(n=a.return)&&n.call(a)}finally{if(t)throw t.error}}return r}),[e])},On=function(e){return Object(oe.useMemo)((function(){var t,n,r;return null!==(r=null===(n=null===(t=null==e?void 0:e.series[0])||void 0===t?void 0:t.meta)||void 0===n?void 0:n.executedQueryString)&&void 0!==r?r:""}),[e])},Sn=function(e,t){return Object(oe.useMemo)((function(){return e!==t}),[e,t])},Tn=function(e){return Object(oe.useMemo)((function(){var t,n,r,a=null===(r=null===(n=null===(t=null==e?void 0:e.series[0])||void 0===t?void 0:t.meta)||void 0===n?void 0:n.custom)||void 0===r?void 0:r.KustoError;return(null==e?void 0:e.error)&&!a?e.error.message?""+e.error.message:""+e.error:a}),[e])},jn=function(e){var t=e.getVariables();return Object(oe.useMemo)((function(){return{label:"Template Variables",expanded:!1,options:t.map((function(e){return{label:e,value:e}}))}}),[t])};var Fn=n(9);function Dn(e,t,n){var r=t.find("#content")[0];function a(e,t){var n=new Ie(e,t.defaultTimeField,t.getSchema,Re.a);n.initMonaco(t.content),n.addCommand(monaco.KeyMod.Shift|monaco.KeyCode.Enter,(function(){var e=n.getValue();t.content=e,t.onChange()})),t.$watch("content",(function(e,r){var a=n.getValue();e!==a&&e!==r&&t.$$postDigest((function(){n.setEditorContent(e)}))})),n.setOnDidChangeModelContent((function(){t.$apply((function(){var e=n.getValue();t.content=e}))})),t.$on("$destroy",(function(){n.disposeMonaco()})),window.onresize=function(){n.resize()}}window.hasOwnProperty("monaco")?setTimeout((function(){a(r,e)}),100):window.System.import("/"+e.pluginBaseUrl+"/libs/monaco.min.js").then((function(){setTimeout((function(){a(r,e)}),100)})),r.onblur=function(){e.onChange()},r.onkeydown=function(e){if("Escape"===e.key)return e.stopPropagation(),!0}}n.n(Fn).a.module("grafana.controllers").directive("kustoMonacoEditor",(function(){return{restrict:"E",template:'<div id="content" tabindex="0" style="width: 100%; height: 150px"></div>',scope:{content:"=",onChange:"&",getSchema:"&",defaultTimeField:"@",pluginBaseUrl:"@"},link:Dn}}));var kn=function(){function e(){this.showHelp=!1,this.defaultQuery='<your table>\n| where $__timeFilter() \n| project TimeGenerated, Text=YourTitleColumn, Tags="tag1,tag2"',this.annotation.query=this.annotation.query||this.defaultQuery,this.annotation.resultFormat="table",this.databases=this.getDatabases()}return e.prototype.getDatabases=function(){var e=this;return this.databases&&this.databases.length>0?this.databases:this.datasource.getDatabases().then((function(t){return e.databases=t,t.length>0&&!e.annotation.database&&(e.annotation.database=t[0].value),e.databases})).catch((function(e){}))},e.templateUrl="partials/annotations.editor.html",e}(),Vn=function(){return ie.a.createElement("div",{className:"gf-form-group"},ie.a.createElement("div",{className:"grafana-info-box"},ie.a.createElement("h5",null,"Configuring Azure and your Azure Data Explorer Database"),ie.a.createElement("h5",null,"1. Create an AAD application"),ie.a.createElement("p",null,"Details on how to do create one via the Azure portal or with the Azure CLI can be found"," ",ie.a.createElement("a",{className:"external-link",target:"_blank",href:"https://github.com/grafana/azure-data-explorer-datasource#configuring-the-datasource-in-grafana"},"here.")),ie.a.createElement("h5",null,"2. Connect the AAD Application to a database user"),ie.a.createElement("p",null,"Navigate to the Azure Data Explorer Web UI via the Azure Portal. The AAD application that you created in step 1 needs to be given viewer access to your Azure Data Explorer database. This is done using the dot command"," ",ie.a.createElement("i",null,"add"),":"),ie.a.createElement("pre",null,".add database your_db_name viewers ('aadapp=your_client_id;your_tenant_id')"),ie.a.createElement("h5",null,"3. Configure the connection in Grafana"),ie.a.createElement("p",null,"Use the details from the AAD Service Principle from Step 1 to fill in the field below. Then click the Save & Test button."),ie.a.createElement("p",null,"Detailed instructions on all three steps can found in"," ",ie.a.createElement("a",{className:"external-link",target:"_blank",href:"https://github.com/grafana/azure-data-explorer-datasource#configuring-the-datasource-in-grafana"},"in the documentation."))))},Nn=Me.LegacyForms.SecretFormField,An=function(e){var t=e.options,n=e.onOptionsChange,r=e.updateJsonData,a=e.handleClearClientSecret,o=t.jsonData,l=t.secureJsonData,u=t.secureJsonFields,s=ie.a.createElement(ie.a.Fragment,null,"To create a new key, log in to Azure Portal, navigate to Azure Active Directory ","๐ก"," App Registrations"," ๐ก "," Choose your app ","๐ก"," Keys.",ie.a.createElement("br",null),ie.a.createElement("br",null),ie.a.createElement("a",{target:"_blank",href:"https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-create-service-principal-portal"},"Click here for detailed instructions on setting up an Azure Active Directory (AD) application."));return ie.a.createElement(Me.FieldSet,{label:"Connection Details"},ie.a.createElement(Me.InlineField,{label:"Cluster URL",labelWidth:26,tooltip:"The cluster url for your Azure Data Explorer database."},ie.a.createElement(Me.Input,{value:o.clusterUrl,id:"adx-cluster-url",placeholder:"https://yourcluster.kusto.windows.net",width:60,onChange:function(e){return r("clusterUrl",e.target.value)}})),ie.a.createElement(Me.InlineField,{label:"Tenant ID",labelWidth:26,tooltip:ie.a.createElement(ie.a.Fragment,null,"In the Azure Portal, navigate to Azure Active Directory ","๐ก"," Properties ","๐ก"," Directory ID.",ie.a.createElement("br",null),ie.a.createElement("br",null),ie.a.createElement("a",{target:"_blank",href:"https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-create-service-principal-portal"},"Click here for detailed instructions on setting up an Azure Active Directory (AD) application."))},ie.a.createElement(Me.Input,{value:o.tenantId,id:"adx-tenant-id",width:60,onChange:function(e){return r("tenantId",e.target.value)}})),ie.a.createElement(Me.InlineField,{label:"Client ID",labelWidth:26,tooltip:ie.a.createElement(ie.a.Fragment,null,"In the Azure Portal, navigate to Azure Active Directory ","๐ก"," App Registrations ","๐ก"," Choose your app ","๐ก","Application ID.",ie.a.createElement("br",null),ie.a.createElement("br",null),ie.a.createElement("a",{target:"_blank",href:"https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-create-service-principal-portal"},"Click here for detailed instructions on setting up an Azure Active Directory (AD) application."))},ie.a.createElement(Me.Input,{value:o.clientId,id:"adx-client-id",width:60,onChange:function(e){return r("clientId",e.target.value)}})),ie.a.createElement(Nn,{label:"Client secret",value:(null==l?void 0:l.clientSecret)||void 0,labelWidth:13,inputWidth:30,placeholder:"",onReset:function(){return a()},onChange:function(e){n(i(i({},t),{secureJsonData:i(i({},l),{clientSecret:!!e&&e.target.value})}))},isConfigured:!!(null==l?void 0:l.clientSecret)||!!(null==u?void 0:u.clientSecret),tooltip:s}))};function _n(e){var t;switch(null==e?void 0:e.type){case"function":var n=null!==(t=e.input)&&void 0!==t?t:[];return e.value+"("+n.map((function(e){return e.Value})).join(",")+")";default:return e.value}}var Mn=function(e){var t=e.options,n=e.schema,r=e.updateJsonData,a=e.onRefresh,o=t.jsonData,l=Object(oe.useMemo)((function(){var e;return null!==(e=o.schemaMappings)&&void 0!==e?e:[]}),[o.schemaMappings]),u=Object(oe.useCallback)((function(){r("schemaMappings",d(l,[{}]))}),[l,r]);return ie.a.createElement(Me.FieldSet,{label:"Database schema settings"},ie.a.createElement(Me.InlineField,{label:"Default database",labelWidth:26},ie.a.createElement(Me.Select,{width:45,options:n.databases,value:n.databases.find((function(e){return e.value===o.defaultDatabase})),onChange:function(e){return r("defaultDatabase",e.value||"")}})),ie.a.createElement(Me.InlineField,{label:"Use managed schema",labelWidth:26},ie.a.createElement(Me.InlineSwitch,{id:"adx-use-schema-mapping",value:o.useSchemaMapping,onChange:function(e){return r("useSchemaMapping",e.target.checked)}})),o.useSchemaMapping&&ie.a.createElement(Me.InlineField,{label:"Schema mappings",labelWidth:26},ie.a.createElement(Me.VerticalGroup,{spacing:"xs"},l.map((function(e,t){return ie.a.createElement(Me.HorizontalGroup,{spacing:"xs",key:t},ie.a.createElement(Me.Select,{value:n.schemaMappingOptions.find((function(t){return t.value===e.value})),options:n.schemaMappingOptions,onChange:function(e){return function(e,t){var a,o=t.value&&(null===(a=n.schemaMappingOptions)||void 0===a?void 0:a.find((function(e){return e.value===t.value})));if(o){var u=d(l);u[e]=i(i({},u[e]),{database:o.database,type:o.type,name:o.value,value:_n(o)}),r("schemaMappings",u)}}(t,e)},width:38,placeholder:"Target"}),ie.a.createElement(Me.InlineLabel,null,ie.a.createElement(Me.Icon,{name:"arrow-right"})),ie.a.createElement(Me.Input,{placeholder:"Name",value:e.displayName,onChange:function(e){return function(e,t){var n=d(l);n[e]=i(i({},n[e]),{displayName:t}),r("schemaMappings",n)}(t,e.target.value)}}),ie.a.createElement(Me.Button,{variant:"secondary",size:"md",icon:"trash-alt","aria-label":"Remove",type:"button",onClick:function(){return function(e){var t=d(l);t.splice(e,1),r("schemaMappings",t)}(t)}}))})),ie.a.createElement(Me.Button,{variant:"secondary",size:"md",onClick:u,type:"button"},"Add mapping"))),ie.a.createElement("br",null),ie.a.createElement(Me.Button,{variant:"primary",onClick:a,type:"button",icon:"sync"},"Reload schema"))},Pn=[{value:"strongconsistency",label:"Strong"},{value:"weakconsistency",label:"Weak"}],In=[{value:b.Visual,label:"Visual"},{value:b.Raw,label:"Raw"}],qn=function(e){var t=e.options,n=e.updateJsonData,r=t.jsonData;return Object(oe.useEffect)((function(){r.dataConsistency||n("dataConsistency",Pn[0].value),r.defaultEditorMode||n("defaultEditorMode",In[0].value)}),[r.dataConsistency,r.defaultEditorMode,n]),ie.a.createElement(Me.FieldSet,{label:"Query Optimizations"},ie.a.createElement(Me.InlineField,{label:"Query timeout",labelWidth:26,tooltip:"This value controls the client query timeout."},ie.a.createElement(Me.Input,{value:r.queryTimeout,id:"adx-query-timeout",placeholder:"30s",width:18,onChange:function(e){return n("queryTimeout",e.target.value)}})),ie.a.createElement(Me.InlineField,{label:"Use dynamic caching",labelWidth:26,tooltip:"By enabling this feature Grafana will dynamically apply cache settings on a per query basis and the default cache max age will be ignored.<br /><br />For time series queries we will use the bin size to widen the time range but also as cache max age."},ie.a.createElement(Me.InlineSwitch,{value:r.dynamicCaching,id:"adx-caching",transparent:!1,onChange:function(e){return n("dynamicCaching",e.target.checked)}})),ie.a.createElement(Me.InlineField,{label:"Cache max age",labelWidth:26,tooltip:"By default the cache is disabled. If you want to enable the query caching please specify a max timespan for the cache to live."},ie.a.createElement(Me.Input,{value:r.cacheMaxAge,id:"adx-cache-age",placeholder:"0m",width:18,onChange:function(e){return n("cacheMaxAge",e.target.value)}})),ie.a.createElement(Me.InlineField,{label:"Data consistency",labelWidth:26,tooltip:"Defaults to Strong"},ie.a.createElement(Me.Select,{options:Pn,value:Pn.find((function(e){return e.value===r.dataConsistency})),onChange:function(e){return n("dataConsistency",e.value?e.value:Pn[0].value)},isClearable:!1,width:18})),ie.a.createElement(Me.InlineField,{label:"Default editor mode",labelWidth:26,tooltip:"Defaults to Visual"},ie.a.createElement(Me.Select,{options:In,value:In.find((function(e){return e.value===r.defaultEditorMode})),onChange:function(e){return n("defaultEditorMode",e.value||b.Visual)},width:18})))};var Rn=function(e){var t=e.options,n=e.updateJsonData,r=t.jsonData;return ie.a.createElement(Me.FieldSet,{label:"Tracking"},ie.a.createElement(Me.InlineField,{label:"Send username header to host",labelWidth:26,tooltip:ie.a.createElement("p",null,"With this feature enabled, Grafana will pass the logged in user's username in the ",ie.a.createElement("code",null,"x-ms-user-id")," ","header and in the ",ie.a.createElement("code",null,"x-ms-client-request-id")," header when sending requests to ADX. Can be useful when tracking needs to be done in ADX."," ")},ie.a.createElement(Me.InlineSwitch,{id:"adx-username-header",value:r.enableUserTracking,onChange:function(e){return n("enableUserTracking",e.target.checked)}})))},Bn=function(e){var t=e.options,n=e.onOptionsChange,r=p(Object(oe.useState)({databases:[],schemaMappingOptions:[]}),2),a=r[0],o=r[1],l=p(Object(oe.useState)(),2),d=l[0],m=l[1],f=t.jsonData,v=function(e){(function(e){return u(this,void 0,Promise,(function(){var t,n,r,a,o,i,l,u,p,d,m,f,v,h,b,w,x,E,O,S,T,j,F,D,k;return s(this,(function(s){switch(s.label){case 0:return t=[],n=[],r={querySource:"schema",csl:".show databases schema as json"},[4,Object(g.getBackendSrv)().datasourceRequest({url:e+"/azuredataexplorer/v1/rest/mgmt",method:"POST",data:r})];case 1:a=s.sent(),o=(new y).parseSchemaResult(a.data);try{for(i=c(Object.values(o.Databases)),l=i.next();!l.done;l=i.next()){u=l.value,t.push({label:u.Name,value:u.Name});try{for(S=void 0,p=c(Object.values(u.Tables)),d=p.next();!d.done;d=p.next())m=d.value,n.push({type:C.table,label:u.Name+"/tables/"+m.Name,value:m.Name,name:m.Name,database:u.Name})}catch(e){S={error:e}}finally{try{d&&!d.done&&(T=p.return)&&T.call(p)}finally{if(S)throw S.error}}try{for(j=void 0,f=c(Object.values(u.Functions)),v=f.next();!v.done;v=f.next())h=v.value,n.push({type:C.function,label:u.Name+"/functions/"+h.Name,value:h.Name,name:h.Name,input:h.InputParameters,database:u.Name})}catch(e){j={error:e}}finally{try{v&&!v.done&&(F=f.return)&&F.call(f)}finally{if(j)throw j.error}}try{for(D=void 0,b=c(Object.values(u.MaterializedViews)),w=b.next();!w.done;w=b.next())x=w.value,n.push({type:C.materializedView,label:u.Name+"/materializedViews/"+x.Name,value:x.Name,name:x.Name,database:u.Name})}catch(e){D={error:e}}finally{try{w&&!w.done&&(k=b.return)&&k.call(b)}finally{if(D)throw D.error}}}}catch(e){E={error:e}}finally{try{l&&!l.done&&(O=i.return)&&O.call(i)}finally{if(E)throw E.error}}return[2,{databases:t,schemaMappingOptions:n}]}}))}))})(e).then((function(e){o(e),m(void 0)})).catch((function(e){return m(e.data)}))},h=Object(oe.useCallback)((function(e,r){var a;n(i(i({},t),{jsonData:i(i({},f),(a={},a[e]=r,a))}))}),[f,n,t]);Object(oe.useEffect)((function(){t.id&&v(t.url)}),[t.id,t.url]),Object(oe.useEffect)((function(){!f.defaultDatabase&&(null==a?void 0:a.databases.length)&&h("defaultDatabase",null==a?void 0:a.databases[0].value)}),[null==a?void 0:a.databases,f.defaultDatabase,h]);var b=Object(oe.useCallback)((function(){v(t.url)}),[t.url]),w=Object(oe.useCallback)((function(){n(i(i({},t),{secureJsonData:i(i({},t.secureJsonData),{clientSecret:!1}),secureJsonFields:i(i({},t.secureJsonFields),{clientSecret:!1})}))}),[n,t]);return ie.a.createElement(ie.a.Fragment,null,ie.a.createElement(Vn,null),ie.a.createElement(An,{options:t,onOptionsChange:n,updateJsonData:h,handleClearClientSecret:w}),ie.a.createElement(qn,{options:t,onOptionsChange:n,updateJsonData:h}),ie.a.createElement(Mn,{schema:a,options:t,onOptionsChange:n,updateJsonData:h,onRefresh:b}),ie.a.createElement(Rn,{options:t,onOptionsChange:n,updateJsonData:h}),d&&ie.a.createElement(Me.Alert,{severity:"error",title:"Error updating Azure Data Explorer schema"},d.message))};n.d(t,"plugin",(function(){return Ln}));var Ln=new r.DataSourcePlugin(X).setConfigEditor(Bn).setAnnotationQueryCtrl(kn).setQueryEditor((function(e){var t,n,r,a,o=e.datasource,l=e.onChange,u=e.onRunQuery,s=e.query,c=On(e.data),p=Tn(e.data),m=Sn(e.query.query,c),f=function(e){var t;if(void 0===e.query.rawMode&&e.query.query&&!(null===(t=e.query.expression)||void 0===t?void 0:t.from))return!0;return e.query.rawMode||!1}(e),v=se((function(){return o.getSchema(!1)}),[o.id]),h=jn(o),g=En(v.value),y=xn(g,e.query,o);Object(oe.useEffect)((function(){(function(e){return!!e&&(!e.pluginVersion||(!e.querySource||!!pn(e.expression)))})(s)&&(l(function(e){return i(i(i({},x),e),{rawMode:Cn(e),pluginVersion:x.pluginVersion,expression:(t=e.expression,pn(t)?dn(t):null!=t?t:x.expression)});var t}(s)),u()),function(e){return void 0===e.query.rawMode}(e)&&function(e){return e.datasource.getDefaultEditorMode()===b.Raw}(e)&&(l(i(i({},e.query),{rawMode:!0,querySource:b.Raw})),u())}),[]);var w=Object(oe.useCallback)((function(e){l(i(i({},s),{database:e}))}),[l,s]),C=Object(oe.useCallback)((function(){l(i(i({},s),{rawMode:!f,querySource:f?b.Visual:b.Raw}))}),[l,s,f]);if(v.loading)return ie.a.createElement(Ut,null);if(v.error)return(null===(n=null===(t=v.error)||void 0===t?void 0:t.data)||void 0===n?void 0:n.Message)?ie.a.createElement("div",{className:"gf-form"},ie.a.createElement("pre",{className:"gf-form-pre alert alert-error"},"Could not load datasource schema due too: ",null===(a=null===(r=v.error)||void 0===r?void 0:r.data)||void 0===a?void 0:a.Message)):ie.a.createElement("div",{className:"gf-form"},ie.a.createElement("pre",{className:"gf-form-pre alert alert-error"},"Could not load datasource schema: ",String(v.error)));if(0===g.length)return ie.a.createElement("div",{className:"gf-form"},ie.a.createElement("pre",{className:"gf-form-pre alert alert-warning"},"Datasource schema loaded but without any databases and tables, please try again.."));var E=f?b.Raw:b.Visual;return ie.a.createElement(ie.a.Fragment,null,p&&ie.a.createElement("div",{className:"gf-form"},ie.a.createElement("pre",{className:"gf-form-pre alert alert-warning"},"Failed to execute query: ",p)),ie.a.createElement(un,{onRunQuery:e.onRunQuery,onToggleEditorMode:C,editorMode:E,onChangeDatabase:w,database:y,databases:d([h],g),dirty:m}),E===b.Raw&&ie.a.createElement(Ue,i({},e,{schema:v.value,templateVariableOptions:h,lastQuery:c,database:y})),E===b.Visual&&ie.a.createElement(Zt,{datasource:o,database:y,onChangeQuery:e.onChange,query:e.query,schema:v.value,templateVariableOptions:h}))}))}])}));
//# sourceMappingURL=module.js.map